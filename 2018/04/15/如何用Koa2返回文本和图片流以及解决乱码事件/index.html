<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="如何用Koa2返回文本和图片流以及解决乱码事件"><meta name="keywords" content="js,node,koa2"><meta name="author" content="Rao Jinwei,undefined"><meta name="copyright" content="Rao Jinwei"><title>如何用Koa2返回文本和图片流以及解决乱码事件 | Rao Jinwei's Blog</title><link rel="shortcut icon" href="/sl.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.4.2"><script>var GLOBAL = { 
  root: '/',
  algolia: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  localSearch: undefined
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#先用Koa2搭建后台环境-并返回流"><span class="toc-number">2.</span> <span class="toc-text">先用Koa2搭建后台环境,并返回流</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#如何搭建Koa2环境？"><span class="toc-number">2.1.</span> <span class="toc-text">如何搭建Koa2环境？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#如何用Koa2返回流？"><span class="toc-number">2.2.</span> <span class="toc-text">如何用Koa2返回流？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#先实现图片流返回"><span class="toc-number">2.2.1.</span> <span class="toc-text">先实现图片流返回</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#再来实现文档流返回"><span class="toc-number">2.2.2.</span> <span class="toc-text">再来实现文档流返回</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端写个测试测测"><span class="toc-number">2.3.</span> <span class="toc-text">客户端写个测试测测</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#说说遇到的小插曲（重点）"><span class="toc-number">3.</span> <span class="toc-text">说说遇到的小插曲（重点）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#开始研究"><span class="toc-number">3.1.</span> <span class="toc-text">开始研究</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ANSI是什么？"><span class="toc-number">3.2.</span> <span class="toc-text">ANSI是什么？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#结论"><span class="toc-number">4.</span> <span class="toc-text">结论</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://avatars1.githubusercontent.com/u/23609695?s=400&amp;u=d2db8f6efdee5add420addf7f89b916f7ef47ca7&amp;v=4"></div><div class="author-info__name text-center">Rao Jinwei</div><div class="author-info__description text-center">追寻生活的影子</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">11</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">13</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">9</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(http://pic1.win4000.com/wallpaper/7/59bb35a6c903f.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Rao Jinwei's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">如何用Koa2返回文本和图片流以及解决乱码事件</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-04-15</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/js/">js</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/js/node/">node</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div id="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前两天做项目的时候，碰到了一个要在客户端(浏览器)中实现预览txt文档和图片的小需求，在开发过程中遇到了一些有趣的小插曲—客户端读取txt时出现各种奇怪乱码，图片就没问题。一时半会还没找到好的解决方法，因为那天又刚好周五，所以在周末的时候，我决定宅在家里好好研究如何解决这个有趣的现象。</p>
<a id="more"></a>
<h2 id="先用Koa2搭建后台环境-并返回流"><a href="#先用Koa2搭建后台环境-并返回流" class="headerlink" title="先用Koa2搭建后台环境,并返回流"></a>先用Koa2搭建后台环境,并返回流</h2><p>由于公司用的是基于java的后台环境，我电脑上没有搭好这些java框架的环境，于是我就用Koa2(基于Node.js的一个框架)搭建好后台环境，先实现给客户端返回流。</p>
<h3 id="如何搭建Koa2环境？"><a href="#如何搭建Koa2环境？" class="headerlink" title="如何搭建Koa2环境？"></a>如何搭建Koa2环境？</h3><p>搭建koa2非常简单，先在一个新目录下，用<code>npm init --y</code>快递初始化<code>package.json</code>，然后用<code>npm</code>或者<code>yarn</code>装好koa的包</p>
<blockquote>
<p>npm install koa –save 或者 yarn add koa </p>
</blockquote>
<p>新建一个<code>app.js</code>，在里面敲下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">"koa"</span>);</div><div class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</div><div class="line"></div><div class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">`Server is listening at 3000`</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>接着你只需要用<code>node app</code>命令就可以在3000端口上启动一个服务器啦~</p>
<h3 id="如何用Koa2返回流？"><a href="#如何用Koa2返回流？" class="headerlink" title="如何用Koa2返回流？"></a>如何用Koa2返回流？</h3><p>比如，我希望是这样的，客户端请求<code>http://localhost:3000/img?imgName=图片名.jpg</code>这个url时，会返回图片的流，用<code>http://localhost:3000/text?fileName=文档名.txt</code>这个url时，会返回文本的流。那么，该如何实现呢？来，上代码讲解</p>
<p>先安装<code>koa-router</code></p>
<blockquote>
<p>npm install koa-router –save</p>
</blockquote>
<h4 id="先实现图片流返回"><a href="#先实现图片流返回" class="headerlink" title="先实现图片流返回"></a>先实现图片流返回</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//引入koa-router包</span></div><div class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">"koa-router"</span>)();</div><div class="line"><span class="comment">// 引入fs文件系统</span></div><div class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 先实现返回图片流(buffer)</span></div><div class="line">router.get(<span class="string">"/img"</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</div><div class="line">  <span class="keyword">let</span> &#123; imgName &#125; = ctx.request.query; <span class="comment">// 提取参数</span></div><div class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> readImg(imgName);</div><div class="line">  <span class="comment">// res 为 Buffer流</span></div><div class="line">  <span class="keyword">if</span> (res) &#123;</div><div class="line">    ctx.type = <span class="string">"jpg"</span>;</div><div class="line">    ctx.body = res;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">await</span> next();</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 用fs处理流</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">readImg</span>(<span class="params">filePath</span>) </span>&#123;</div><div class="line">  <span class="comment">// 创建可读流</span></div><div class="line">  <span class="keyword">let</span> data = [];</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> readerStream = fs.createReadStream(<span class="string">`./public/<span class="subst">$&#123;filePath&#125;</span>`</span>);</div><div class="line">    readerStream.on(<span class="string">"data"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</div><div class="line">      data.push(chunk);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    readerStream.on(<span class="string">"end"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="keyword">const</span> finalData = Buffer.concat(data); <span class="comment">// 合并Buffer</span></div><div class="line">      res(finalData);</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果对上面代码有疑惑，建议先学习<code>ES7</code>的<code>async await</code>语法，再去读读Koa2的官方文档，有关<code>async await</code>的知识我到时会写一篇博客来讲解。</p>
<blockquote>
<p>关于<code>async await</code>的学习可以<a href="http://es6.ruanyifeng.com/#docs/async" target="_blank" rel="external">点这里</a></p>
<p>Koa2官网文档<a href="https://koa.bootcss.com/" target="_blank" rel="external">点这里</a></p>
</blockquote>
<h4 id="再来实现文档流返回"><a href="#再来实现文档流返回" class="headerlink" title="再来实现文档流返回"></a>再来实现文档流返回</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">"/text"</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</div><div class="line">  <span class="keyword">let</span> &#123; fileName &#125; = ctx.request.query; <span class="comment">// 提取参数</span></div><div class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> readTXT(fileName);</div><div class="line">  <span class="keyword">if</span> (res) &#123;</div><div class="line">    ctx.type = <span class="string">"text"</span>;</div><div class="line">    ctx.body = res;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">await</span> next();</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">readTXT</span>(<span class="params">filePath</span>) </span>&#123;</div><div class="line">  <span class="comment">// 创建可读流</span></div><div class="line">  <span class="keyword">let</span> data = []; </div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> readerStream = fs.createReadStream(<span class="string">`./public/<span class="subst">$&#123;filePath&#125;</span>`</span>);</div><div class="line">    readerStream.on(<span class="string">"data"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</div><div class="line">      data.push(chunk);</div><div class="line">    &#125;);</div><div class="line">    <span class="comment">// 读完后promise返回</span></div><div class="line">    readerStream.on(<span class="string">"end"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="keyword">const</span> finalData = Buffer.concat(data);</div><div class="line">      res(finalData);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    readerStream.on(<span class="string">"error"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">      rej(err);</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着，重要的不要忘处理跨域，应该客户端是在其他端口打开的<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 处理跨域</span></div><div class="line">router.all(<span class="string">"/*"</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</div><div class="line">  <span class="comment">// *代表允许来自所有域名请求</span></div><div class="line">  ctx.set(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"*"</span>);</div><div class="line">  <span class="comment">// 其他一些设置...</span></div><div class="line">  <span class="keyword">await</span> next();</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// use router</span></div><div class="line">app.use(router.routes());</div><div class="line"></div><div class="line"><span class="comment">// 最后启动服务器</span></div><div class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">`Server is listening at 3000`</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>于是后端环境就搭建好了，下面来说说客户端怎么写测试</p>
<h3 id="客户端写个测试测测"><a href="#客户端写个测试测测" class="headerlink" title="客户端写个测试测测"></a>客户端写个测试测测</h3><p>核心代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 简单封装ajax</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ajax</span>(<span class="params">url</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</div><div class="line">    xhr.open(<span class="string">'GET'</span>, url, <span class="literal">true</span>);</div><div class="line">    xhr.responseType = <span class="string">'blob'</span>;</div><div class="line">    xhr.onload = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">      <span class="keyword">if</span>(xhr.readyState == <span class="number">4</span>) &#123;</div><div class="line">        <span class="keyword">if</span>(xhr.status == <span class="number">200</span>) &#123;</div><div class="line">          <span class="keyword">const</span> blob = xhr.response;</div><div class="line">          resolve(blob);</div><div class="line">        &#125;<span class="keyword">else</span> &#123;</div><div class="line">          reject(xhr.statusText);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// get请求添加查询参数</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">urlParam</span>(<span class="params">url, name, value</span>) </span>&#123;</div><div class="line">    url += (url.indexOf(<span class="string">'?'</span>) == <span class="number">-1</span>) ? <span class="string">'?'</span> : <span class="string">'&amp;'</span>;</div><div class="line">    url += <span class="built_in">encodeURIComponent</span>(name) + <span class="string">"="</span> + <span class="built_in">encodeURIComponent</span>(value);</div><div class="line">    <span class="keyword">return</span> url;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 点击获取图片，并渲染到页面上</span></div><div class="line">reqImg.addEventListener(<span class="string">'click'</span>, () =&gt; &#123;</div><div class="line">    <span class="keyword">const</span> url = urlParam(<span class="string">'http://localhost:3000/img'</span>, <span class="string">'imgName'</span>, <span class="string">'duang.jpg'</span>);</div><div class="line">    ajax(url).then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</div><div class="line">      <span class="keyword">const</span> blob = response;</div><div class="line">      <span class="keyword">const</span> img = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</div><div class="line">      img.src = <span class="built_in">window</span>.URL.createObjectURL(blob);</div><div class="line">      <span class="built_in">document</span>.body.appendChild(img);</div><div class="line">  &#125;)</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="comment">// 点击获取txt,并渲染</span></div><div class="line">reqTxt.addEventListener(<span class="string">'click'</span>, () =&gt; &#123;</div><div class="line">    <span class="keyword">const</span> url = urlParam(<span class="string">'http://localhost:3000/text'</span>, <span class="string">'fileName'</span>, <span class="string">'utf8.txt'</span>);</div><div class="line">    ajax(url).then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> data = response;</div><div class="line">    <span class="keyword">const</span> reader = <span class="keyword">new</span> FileReader();</div><div class="line">    reader.readAsText(data);</div><div class="line">    reader.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="keyword">const</span> pre = <span class="built_in">document</span>.createElement(<span class="string">'pre'</span>);</div><div class="line">      pre.innerText = <span class="keyword">this</span>.result;</div><div class="line">      <span class="built_in">document</span>.body.appendChild(pre);</div><div class="line">    &#125;</div><div class="line">  &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>好了，测试看看</p>
<p><img src="/images/20180415/test1.png" alt="测试结果"></p>
<p>恩，到这就已经实现服务端可以返回流，客户端请求并渲染了。</p>
<h2 id="说说遇到的小插曲（重点）"><a href="#说说遇到的小插曲（重点）" class="headerlink" title="说说遇到的小插曲（重点）"></a>说说遇到的小插曲（重点）</h2><p>在前天开发的时候，后端给我传回了文本流，我这边也拿到了，不过在渲染时出现了很多乱七八糟的码，看得我头皮发麻。。。然后经过沟通发现，发现客户上传的txt不是<code>utf-8</code>编码的，是<code>ANSI</code>这种编码格式。接着，后端大佬问我能不能在客户端通过js来渲染<code>ANSI</code>格式的txt文档，因为后台转码可以会带来性能的一些问题。为了能解决这个问题，经过我周末的仔细研究和反复测试，发现问题不算很复杂，主要涉及到了一些关于编码方面的知识。</p>
<h3 id="开始研究"><a href="#开始研究" class="headerlink" title="开始研究"></a>开始研究</h3><p>首先，我试着保存一个<code>ANSI</code>编码的txt文本</p>
<p><img src="/images/20180415/ansi.png" alt="保存ANSI"></p>
<p>然后通过服务端返回流，看看客户端会不会出现乱码<br>服务端代码不改，只改了客户端请求的文件，文件名为<code>ANSI</code>格式的txt</p>
<p>结果</p>
<p><img src="/images/20180415/test2.png" alt="测试结果"></p>
<p>果不奇然，跟前天一样，乱码！出了一堆���的玩意！</p>
<p>怎么才能把这些神奇的字符翻译过来呢，于是，我就想有什么api可以，经过我一番查找，发现<code>FileReader的api readAsText(data, encoding)</code>第二个参数貌似可以翻译过来！突然有点小鸡冻，二话不说，赶紧试了下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">reader.readAsText(data, <span class="string">"ANSI"</span>);</div></pre></td></tr></table></figure>
<p>刷新浏览器，点了下测试button，结果…</p>
<p><img src="/images/20180415/test2.png" alt="测试结果"></p>
<p>还是一样啊！！！难道<code>readAsText</code>不支持<code>ANSI</code>这种编码格式吗？？？</p>
<p><img src="/images/20180415/zk.jpg" alt="duang"></p>
<h3 id="ANSI是什么？"><a href="#ANSI是什么？" class="headerlink" title="ANSI是什么？"></a>ANSI是什么？</h3><p>我在想，<code>ANSI</code>到底是一种什么样的编码，为什么不能转，于是通过搜索引擎去查查看，发现</p>
<blockquote>
<p>不同的国家和地区制定了不同的标准，由此产生了 GB2312、GBK、Big5、Shift_JIS 等各自的编码标准。这些使用 1 至 4 个字节来代表一个字符的各种汉字延伸编码方式，称为 ANSI 编码。在简体中文Windows操作系统中，ANSI 编码代表 GBK(GB2312) 编码；在日文Windows操作系统中，ANSI 编码代表 Shift_JIS 编码。</p>
</blockquote>
<p>这么说，<code>ANSI</code>只是一种假象？？？</p>
<p>接着google继续找</p>
<p><img src="/images/20180415/what.png" alt="老外说ANCI是个bad joke"></p>
<p>看完了一圈下来，我终于明白了，原来根本就没有<strong>ANSI</strong>这种编码！只是一种泛型！在不同的Windows版本里，<code>ANSI</code>是<code>gbk</code>或者<code>gb2312</code>编码，在日文中，为<code>Shift_JIS</code>编码，在繁体中文中，为<code>big5</code>编码。</p>
<p>于是，我用<code>nodepad++</code>打开<code>anci.txt</code>发现</p>
<p><img src="/images/20180415/gb2312.png" alt="gb2312"></p>
<p>果然是<strong>gb2312</strong>编码！！！<strong>所以，用UTF-8(网页默认)去读gb2312编码文档是会出现乱码情况的</strong>。</p>
<p>so，换个角度，我是不是通过这么修改达到我的目的呢？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">reader.readAsText(data, <span class="string">"gb2312"</span>);</div></pre></td></tr></table></figure>
<p>感觉是可以的，突然又有了一点小鸡冻！！！试试看~</p>
<p>duang~</p>
<p><img src="/images/20180415/test3.png" alt="测试结果"></p>
<p>结果能正常显示了！！！Yeah~</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><blockquote>
<p>事实上，所谓的「ANSI」指的是对应当前系统 locale 的遗留（legacy）编码。不要用记事本，用专业的文本编辑器保存为不带 BOM 的 UTF-8。(知乎大V)</p>
</blockquote>
<p>记得有位前辈说过，文档最好不要用记事本保存，用nodepad++最好，以免出现无法预测的错误。到了今天我才知道，原来，那位前辈说的话恰好印证了上面某知乎大V说的，尽量不要用记事本保存。但是，毕竟客户不是搞开发的，他们也不知道这样编码的玩意，他们百分之99.999%都是用记事本打开保存文档，然后上传，所以，在以后开发中，若是再出现这种情况，应该跟后端沟通好，如果是gb2312编码格式的txt，就返回字段告诉前端，用<code>reader.readAsText(data, &quot;gb2312&quot;)</code>去读写文档，避免出现乱码的尴尬现象。</p>
<p>最后附上demo的github地址: <a href="https://github.com/shooterRao/node-demo/tree/master/koa2-stream" target="_blank" rel="external">https://github.com/shooterRao/node-demo/tree/master/koa2-stream</a></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Rao Jinwei</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://shooterblog.site/2018/04/15/如何用Koa2返回文本和图片流以及解决乱码事件/">http://shooterblog.site/2018/04/15/如何用Koa2返回文本和图片流以及解决乱码事件/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明来自 <a href="http://shooterblog.site" target="_blank">Rao Jinwei's Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/js/">js</a><a class="post-meta__tags" href="/tags/node/">node</a><a class="post-meta__tags" href="/tags/koa2/">koa2</a></div><elif theme.sharejs && theme.sharejs.enable></elif></article><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/05/19/手把手教你用Vscode Debugger调试代码/"><i class="fa fa-chevron-left">  </i><span>手把手教你用Vscode Debugger调试代码</span></a></div><div class="next-post pull-right"><a href="/2018/02/28/聊聊JS里的this/"><span>聊聊JS里的this</span><i class="fa fa-chevron-right"></i></a></div></nav><elif theme.laibili && theme.laibili.enable></elif><elif theme.gitment && theme.gitment.enable></elif><elif theme.gitalk && theme.gitalk.enable></elif></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2018 By Rao Jinwei</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.4.2"></script><script src="/js/fancybox.js?version=1.4.2"></script><script src="/js/sidebar.js?version=1.4.2"></script><script src="/js/copy.js?version=1.4.2"></script><script src="/js/fireworks.js?version=1.4.2"></script><script src="/js/transition.js?version=1.4.2"></script><script src="/js/scroll.js?version=1.4.2"></script><script src="/js/head.js?version=1.4.2"></script></body></html>