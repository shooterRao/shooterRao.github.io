<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Vuecli2引入Arcgis-js-api方案总结(非esri-loader方向)"><meta name="keywords" content="webpack,vue,arcgis"><meta name="author" content="Rao Jinwei,undefined"><meta name="copyright" content="Rao Jinwei"><title>Vuecli2引入Arcgis-js-api方案总结(非esri-loader方向) | Rao Jinwei's Blog</title><link rel="shortcut icon" href="/sl.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.4.2"><script>var GLOBAL = { 
  root: '/',
  algolia: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  localSearch: undefined
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#已实现的功能"><span class="toc-number">2.</span> <span class="toc-text">已实现的功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#方案选择"><span class="toc-number">3.</span> <span class="toc-text">方案选择</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#esri-loader"><span class="toc-number">3.1.</span> <span class="toc-text">esri-loader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#改-webpack-配置"><span class="toc-number">3.2.</span> <span class="toc-text">改 webpack 配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vuex-的作用"><span class="toc-number">4.</span> <span class="toc-text">vuex 的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Eslint-和-Prettier"><span class="toc-number">5.</span> <span class="toc-text">Eslint 和 Prettier</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Githook"><span class="toc-number">6.</span> <span class="toc-text">Githook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Arcgis-框架-api-语法提示"><span class="toc-number">7.</span> <span class="toc-text">Arcgis 框架 api 语法提示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#写在最后"><span class="toc-number">8.</span> <span class="toc-text">写在最后</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://avatars1.githubusercontent.com/u/23609695?s=400&amp;u=d2db8f6efdee5add420addf7f89b916f7ef47ca7&amp;v=4"></div><div class="author-info__name text-center">Rao Jinwei</div><div class="author-info__description text-center">追寻生活的影子</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">13</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">15</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">9</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(http://pic1.win4000.com/wallpaper/7/59bb35a6c903f.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Rao Jinwei's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">Vuecli2引入Arcgis-js-api方案总结(非esri-loader方向)</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-09-23</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/vue/">vue</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div id="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>三个月前，我在公司内部进行了一次关于<a href="https://github.com/shooterRao/Arcgis-webpack-PPT" target="_blank" rel="external">arcgis+webpck 实现前端工程化</a>的技术分享。在那次分享中，我分别简单举例了关于<code>react+webpack+arcgis</code>、<code>vue+webpack+arcgis</code>、<code>ts+dojo+webpack+arcgis</code>这几个方案的<a href="https://github.com/shooterRao/arcgis-webpack-demo" target="_blank" rel="external">实现</a>，其中对<a href="https://github.com/shooterRao/arcgis-webpack-vue" target="_blank" rel="external">vue+webpack+arcgis</a>这一方案进行比较多的讲解，但那时候的<code>vue-arcgis-demo</code>是直接用<strong>webpack4.8.3</strong>从零开始构建的，并没有在<code>vuecli2</code>生成的项目基础上进行修改，在配置方面还是存在许多<strong>不足</strong>。后来我仔细研究了 vuecli2 生成项目的 webpack 配置，搞明白之后就直接改配置并成功接入 arcgis 框架了，下面总结一下这个过程。</p>
<a id="more"></a>
<h2 id="已实现的功能"><a href="#已实现的功能" class="headerlink" title="已实现的功能"></a>已实现的功能</h2><p>在 vuecli2 生成项目的基础上，经过修改 webpack 配置和引入一些模块实现了以下几个功能：</p>
<ul>
<li>修改 webpack 配置支持使用 arcgis 框架，支持<code>import Map from &#39;esri/Map&#39;</code>写法</li>
<li>修改<code>html-webpack-plugin</code>配置，支持动态<code>require</code>注入带<strong>Hash</strong>后缀的 js 和 css 文件</li>
<li>增加外部配置文件，支持动态加载 arcgis 框架或其它工具库</li>
<li>引入<code>@types/arcgis-js-api</code>，<code>@types/dojo</code>，<code>tsd.d.ts</code>，提供 arcgis 框架及 dojo 框架相关 api 语法提示</li>
<li>引入 vuex，方便在 Map 组件实例已挂载情况下，其它组件可以通过<code>this.map</code>方法来获取地图实例对象</li>
<li>引入 eslint(airbnb)、prettier</li>
<li>引入 githook(pre-commit)，git</li>
</ul>
<h2 id="方案选择"><a href="#方案选择" class="headerlink" title="方案选择"></a>方案选择</h2><h3 id="esri-loader"><a href="#esri-loader" class="headerlink" title="esri-loader"></a>esri-loader</h3><p><code>esri-loader</code>是在 esri 公司工作老外写的一个加载器。我看到在公司一些弱 gis 的项目中有用到，也就是用<code>esri-loader</code>把 arcgis 里的相关模块给加载出来，下面是官方文档的例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">esriLoader</div><div class="line">  .loadModules([<span class="string">"esri/views/MapView"</span>, <span class="string">"esri/WebMap"</span>])</div><div class="line">  .then(<span class="function">(<span class="params">[MapView, WebMap]</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> webmap = <span class="keyword">new</span> WebMap(&#123;</div><div class="line">      portalItem: &#123;</div><div class="line">        id: <span class="string">"f2e9b762544945f390ca4ac3671cfa72"</span></div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">const</span> view = <span class="keyword">new</span> MapView(&#123;</div><div class="line">      map: webmap,</div><div class="line">      container: <span class="string">"viewDiv"</span></div><div class="line">    &#125;);</div><div class="line">  &#125;)</div><div class="line">  .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.error(err);</div><div class="line">  &#125;);</div></pre></td></tr></table></figure>
<p>从代码上看，esriLoader 实际上返回的是一个<code>Promise</code>实例，里面包装这相关的模块。后来我看了下这个 esriLoader 的源码，实际上它是通过动态创建<code>&lt;script&gt;</code>标签加载 arcgis 框架，然后再去通过<code>require([&#39;mduleA&#39;, &#39;moduleB&#39;])</code>去加载相关模块，最后<code>Promise.resolve([])</code>出来。</p>
<p>这种方案虽然是可以解决加载地图的问题，但是如果把这种方案放在强 gis 项目上，那意味着所有 arcgis 相关模块都强依赖于<code>esriLoader.loadModules</code>，地图相关操作的方法都不太好进行抽象和管理，完全耦合在每个组件里面了，也不方便进行拓展。还有个问题，由于<code>arcgis js api</code>的<code>init.js</code>很大，如果在网络不好的情况下，初次挂载地图组件可能会出现等待时间比较久的问题。</p>
<p>但是，如果是弱 gis 方面的项目，不需要进行太多地图相关的操作，使用 esriloader 是一种不错的方案，因为使用它完全不需要修改 vuecli 的相关配置，可以直接采用 webpack 默认的加载器，使用起来几乎没什么成本。</p>
<h3 id="改-webpack-配置"><a href="#改-webpack-配置" class="headerlink" title="改 webpack 配置"></a>改 webpack 配置</h3><p>其实，做这种接入适配最难搞的是如何让 webpack 接入 arcgis 框架。首先 arcgis js api 依赖 dojo1，dojo1 用的是<code>require.js</code>AMD 模块加载器(dojo2 已经重构，不再依赖 require.js，但是最新的 arcgis 仍然用 dojo1)，所以 arcgis 框架内部也是基于 AMD 模块方式编写的，webpack 也是模块打包器，只不过比<code>require.js</code>强大得多，思想更加先进，功能也更加丰富。webpack 默认打包出来的模块不是 AMD 模块，所以导致打包出来的模块和 arcgis 框架的 AMD 模块天然不和，也就不能直接地使用<code>import Map from &#39;esri/Map</code>这类的写法。虽然 arcgis 模块无法被打包成 webpack 可以认识的模块，但是反过来，强大的 webpack 可以把模块打包成 AMD 模块，让 arcgis 框架识别并加载出来，所以问题就解决了。</p>
<p>下面，是每个步骤的详细介绍：</p>
<ul>
<li>首先，第一步，如上文说的，让 webpack 帮我们打包模块为 AMD 模块。这里，我们可以直接在<code>vue/build/webpack.base.conf.js</code>文件中，webpack 的 output 配置中加多一行代码：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  output: &#123;</div><div class="line">    libraryTarget: <span class="string">"amd"</span> <span class="comment">// 解决amd模块问题</span></div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<ul>
<li>既然让 webpack 把所有模块都打包成 AMD 模块了，那么 webpack 在处理<code>import Map from &#39;esri/Map&#39;</code>这块代码时，仍然会报错。为什么？因为项目和<code>node_modules</code>中没有<code>esri</code>这个模块，<code>esri</code>的模块是通过<code>require.js</code>进行加载的。所以解决方法是添加 webpack 配置，让 webpack 在处理类似<code>import Map from &#39;esri/Map&#39;</code>这种<code>esri</code>、<code>dojo</code>开头的模块，不作处理，直接放回<code>Map</code>，统一用<code>require.js</code>进行加载。具体方法如下：</li>
</ul>
<p>依旧在<code>vue/build/webpack.base.conf.js</code>文件中，添加如下配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  <span class="comment">// 末尾添加即可 (其实顺序不重要)</span></div><div class="line">  externals: [</div><div class="line">    <span class="comment">// 当遇到引入包含dojo/esri/dgp等模块时，不处理</span></div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">context, request, callback</span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span> (</div><div class="line">        /^dojo/.test(request) ||</div><div class="line">        /^dojox/.test(request) ||</div><div class="line">        /^dijit/.test(request) ||</div><div class="line">        /^esri/.test(request)</div><div class="line">      ) &#123;</div><div class="line">        <span class="keyword">return</span> callback(<span class="literal">null</span>, <span class="string">"amd "</span> + request);</div><div class="line">      &#125;</div><div class="line">      callback();</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<ul>
<li><p>剩下要解决的是<code>html-webpack-plugin</code>插件动态注入资源的问题了。在开发环境和生成环境中，vuecli2 是默认开启让<code>html-webpack-plugin</code>插件动态注入资源到<code>index.html</code>模块上的，所谓的资源，主要就是 webpack 构建完成后的 js 和 css。默认的注入方式是构建<code>script</code>标签进行 src 引入。因为 webpack 打包后的模块都是<code>define(xxx, function())</code>这种形式的 AMD 模块，通过<code>script</code>标签引入浏览器是识别不了的，所以必须得用<code>require(xxx)</code>方法进行加载。为了解决这个问题，我在<code>vue/build/webpack.dev.conf.js</code>和<code>vue/build/webpack.prod.conf.js</code>文件中找到<code>html-webpack-plugin</code>插件的相关配置，发现它的默认配置项不多，<code>dev</code>和<code>prod</code>的配置区别也就是路径和是否压缩，可参考的选项并不多。所以我只好去<code>html-webpack-plugin</code>插件的<a href="https://github.com/ampedandwired/html-webpack-plugin" target="_blank" rel="external">github 文档</a>上查询是否有我想要的 api，更改动态输出 js 的方法。经过一番查阅，发现只能通过引入自定义的 html 模板，再添加<code>loadsh</code>模板语法进行动态注入资源。</p>
<p>1.首先，统一在<code>html-webpack-plugin</code>的配置对象中添加<code>inject: false</code></p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> HtmlWebpackPlugin(&#123;</div><div class="line">  filename: <span class="string">"index.html"</span>,</div><div class="line">  template: <span class="string">"index.html"</span>,</div><div class="line">  inject: <span class="literal">false</span> <span class="comment">// 不进行自动注入，改为模板注入</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>2.在根目录下的<code>index.html</code>下进行添加模板语法，分别处理打包好的 css 和 js</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">...</div><div class="line"><span class="comment">&lt;!-- 动态注入app.hash.css等 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">for</span>(<span class="attr">const</span> <span class="attr">cssChunk</span> <span class="attr">of</span> <span class="attr">htmlWebpackPlugin.files.css</span>) &#123;%&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&lt;%= cssChunk %&gt;"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>/&gt;</span>&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="javascript">  <span class="keyword">var</span> chunks = [];</span></div><div class="line"><span class="javascript">  <span class="string">`&lt;% for (const jsChunk of htmlWebpackPlugin.files.js) &#123; %&gt;`</span></span></div><div class="line"><span class="javascript">    chunks.push(<span class="string">"&lt;%= jsChunk %&gt;"</span>);</span></div><div class="line"><span class="javascript">  <span class="string">`&lt;% &#125; %&gt;`</span></span></div><div class="line"><span class="javascript">  <span class="comment">// 通过require加载打包好的模块(manifest.hash.js,、vendor.hash.js、app.hash.js...)</span></span></div><div class="line"><span class="javascript">  <span class="built_in">require</span>(chunks)</span></div><div class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure>
<p><strong>注意：在生产环境中，这些 chunk 都是带有 Hash 值的，高效利用浏览器缓存机制</strong></p>
<p>3.完成以上步骤之后，最重要的是，在加载业务模块之前，必须先加载 arcgis 框架。方法有 2 种，一是直接在<code>index.html</code>模板里面添加，二是继续利用<code>html-webpack-plugin</code>把框架引入进来。我个人认为第二种方式更为优雅，也方便开发的小伙伴在不同个人环境中修改配置项，所以用了第二种方法：</p>
<p>先在根目录下创建<code>appConfig.js</code>，添加以下内容：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  htmlOpts: &#123;</div><div class="line">    title: <span class="string">"vuecli2-arcgis-base"</span>,</div><div class="line">    libs: &#123;</div><div class="line">      arcgisJsApi: &#123;</div><div class="line">        js: <span class="string">"http://localhost:8080/arcgis4.7/init.js"</span>,</div><div class="line">        css: <span class="string">"http://localhost:8080/arcgis4.7/esri/css/main.css"</span></div><div class="line">      &#125;</div><div class="line">      <span class="comment">// 这里可以继续添加各种库jq，lodash...</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>再在<code>index.html</code>模板中进行引入：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line"><span class="comment">&lt;!-- 动态注入自定义css --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">for</span>(<span class="attr">const</span> <span class="attr">i</span> <span class="attr">of</span> <span class="attr">Object.keys</span>(<span class="attr">htmlWebpackPlugin.options.libs</span>)) &#123;%&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">const</span> <span class="attr">lib</span> = <span class="string">htmlWebpackPlugin.options.libs[i]%</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">if</span>(!!<span class="attr">lib.css</span>) &#123; %&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">'stylesheet'</span> <span class="attr">href</span>=<span class="string">'&lt;%= lib.css %&gt;'</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- 最开头引入lib --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">for</span>(<span class="attr">const</span> <span class="attr">i</span> <span class="attr">of</span> <span class="attr">Object.keys</span>(<span class="attr">htmlWebpackPlugin.options.libs</span>)) &#123;%&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">const</span> <span class="attr">lib</span> = <span class="string">htmlWebpackPlugin.options.libs[i]%</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">if</span>(!!<span class="attr">lib.js</span>) &#123; %&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&lt;%= lib.js %&gt;"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></div></pre></td></tr></table></figure>
<p>这样差不多就完成了，不过，我觉得可以封装下相关配置，在<code>vue/build/webpack.dev.conf.js</code>里面加入：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 配置配置文件合并HtmlWebpackPlugin选项</span></div><div class="line"><span class="keyword">const</span> htmlOpts = <span class="built_in">require</span>(<span class="string">"../appConfig.js"</span>).htmlOpts;</div><div class="line"><span class="comment">// 默认配置</span></div><div class="line"><span class="keyword">const</span> htmlDevOpts = &#123;</div><div class="line">  filename: <span class="string">"index.html"</span>,</div><div class="line">  template: <span class="string">"index.html"</span>,</div><div class="line">  inject: <span class="literal">false</span>,</div><div class="line">  chunks: <span class="string">"all"</span></div><div class="line">&#125;;</div><div class="line"><span class="comment">// 合并配置</span></div><div class="line"><span class="keyword">const</span> HtmlWebpackPluginOpts = <span class="built_in">Object</span>.assign(&#123;&#125;, htmlDevOpts, htmlOpts);</div><div class="line"><span class="comment">// 在plugin中改为</span></div><div class="line"><span class="keyword">new</span> HtmlWebpackPlugin(HtmlWebpackPluginOpts);</div></pre></td></tr></table></figure>
<p>在<code>vue/build/webpack.prod.conf.js</code>里面，加入差不多的配置</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 配置配置文件合并HtmlWebpackPlugin选项</span></div><div class="line"><span class="keyword">const</span> htmlOpts = <span class="built_in">require</span>(<span class="string">"../appConfig.js"</span>).htmlOpts;</div><div class="line"><span class="comment">// 默认配置</span></div><div class="line"><span class="keyword">const</span> htmlDefaultProdOpts = &#123;</div><div class="line">  filename: config.build.index,</div><div class="line">  template: <span class="string">"index.prod.html"</span>,</div><div class="line">  inject: <span class="literal">false</span>,</div><div class="line">  minify: &#123;</div><div class="line">    removeComments: <span class="literal">true</span>,</div><div class="line">    collapseWhitespace: <span class="literal">true</span>,</div><div class="line">    removeAttributeQuotes: <span class="literal">true</span></div><div class="line">  &#125;,</div><div class="line">  chunksSortMode: <span class="string">"dependency"</span>,</div><div class="line">  chunks: <span class="string">"all"</span></div><div class="line">&#125;;</div><div class="line"><span class="comment">// 合并配置</span></div><div class="line"><span class="keyword">const</span> HtmlWebpackPluginOpts = <span class="built_in">Object</span>.assign(&#123;&#125;, htmlDefaultProdOpts, htmlOpts);</div><div class="line"></div><div class="line"><span class="keyword">new</span> HtmlWebpackPlugin(HtmlWebpackPluginOpts);</div></pre></td></tr></table></figure>
<p><strong>注意：在根目录中添加 index.prod.html 文件，区别于开发环境</strong></p>
<p>最后，可以分别尝试用<code>yarn dev</code>，<code>yarn build</code>进行测试下，如果步骤 ✅ 的话，项目是可以正常运行的。</p>
<h2 id="vuex-的作用"><a href="#vuex-的作用" class="headerlink" title="vuex 的作用"></a>vuex 的作用</h2><p>在一些弱 gis 项目中，我看到大部分是采用<code>EventBus</code>这种方式进行跨组件的事件传播。事件少的情况倒没什么，只要注意<strong>多次挂载的组件必须在 destroy 声明周期中解除绑定的事件</strong>即可。但是对于强 gis 项目，地图<code>Map</code>实例对象是很多组件会频繁用到的，如果大量使用<code>EventBus</code>进行<code>Map</code>对象传递和事件分发，这样维护起来非常困难。所以，引入<code>vuex</code>进行<code>Map</code>对象缓存和全局状态管理是种不错的方法，<code>vuex</code>其实相当于组件可共享的全局变量，但是不会直接暴露在<code>window</code>全局变量上。</p>
<p>我们可以简单写个 map 的 store：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> map = &#123;</div><div class="line">  state: &#123;</div><div class="line">    map: <span class="literal">null</span>,</div><div class="line">    mapView: <span class="literal">null</span></div><div class="line">  &#125;,</div><div class="line">  actions: &#123;</div><div class="line">    setMap(&#123; commit &#125;, value) &#123;</div><div class="line">      commit(<span class="string">"SET_MAP"</span>, value);</div><div class="line">    &#125;,</div><div class="line">    setMapView(&#123; commit &#125;, value) &#123;</div><div class="line">      commit(<span class="string">"SET_MAPVIEW"</span>, value);</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  mutations: &#123;</div><div class="line">    SET_MAP(state, value) &#123;</div><div class="line">      state.map = value;</div><div class="line">    &#125;,</div><div class="line">    SET_MAPVIEW(state, value) &#123;</div><div class="line">      state.mapView = value;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><strong>map 的 store 最好通过以 module 的形式进行注册</strong></p>
<p>在 Map 组件实例化后，<code>map</code>和<code>mapView</code>对象会缓存在 vuex 中，在所有组件中都可以通过<code>const { map, mapView } = this.$store.state.map</code>这种方式进行取到对应的值</p>
<p>但是这种方法还不算方便，我们可以通过<code>vuex</code>提供的<code>getter</code>方法进行取<code>map</code>和<code>mapView</code>对象，创建<code>getters.js</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</div><div class="line">  map: <span class="function"><span class="params">state</span> =&gt;</span> state.map.map,</div><div class="line">  mapView: <span class="function"><span class="params">state</span> =&gt;</span> state.map.mapView</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>然后在<code>new Vuex.Store({ getters })</code>注册 getters</p>
<p>接着，在其它组件中，加入：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; mapGetters &#125; <span class="keyword">from</span> <span class="string">"vuex"</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</div><div class="line">  computed: &#123;</div><div class="line">    ...mapGetters([<span class="string">"map"</span>, <span class="string">"mapView"</span>]) <span class="comment">// 在函数中通过this.map、this.mapVie就可以获取相关对象了</span></div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><strong>mapGetters 这类对象可以统一用<code>Mixins: []</code>方式进行挂载</strong></p>
<h2 id="Eslint-和-Prettier"><a href="#Eslint-和-Prettier" class="headerlink" title="Eslint 和 Prettier"></a>Eslint 和 Prettier</h2><p>在我接手维护广州项目的时候，发现里面的项目代码是没有规范的，代码风格迥异，注释较少，所以在加需求和改 bug 的时候就非常痛苦了，最担心的是，一不小心改错了地方然后导致影响了其它功能，强耦合的代码很容易引发链式 bug 反应 🙈。对于没有注释的代码，想要读懂里面的逻辑往往要在里面进行 debugger，有时还要去猜。更让人难受的是，有一些模块功能很多，所以代码量大，一个 js 最多达到 3000+甚至 4000+行，也没有对模块进行业务和功能函数的拆分。其实这些的根本原因就是前期开发，没有约定好代码规范用工具来进行强制约束，导致后面越来越多坑，也就越来越难维护。</p>
<p>想要解决这个问题，最好的方法是前期就必须要引入<code>Eslint</code>来制订代码规范，使用<code>prettier</code>来统一代码风格。虽然没适应<code>Eslint</code>的童鞋会感到很难受，因为会出现很多编译不通过的问题，我开始也一样，但这些都是小问题，只需要按造<code>Eslint</code>制定好的规范进行对应的代码修改，长期下来，你会发现<code>Eslint</code>不仅能帮你避免编写低级错误的代码，还能提升团队的代码质量，更容易阅读。</p>
<p><code>prettier</code>是一个代码格式化工具，我很早就已经开始使用了。这是一款非常非常给力的工具，它运用自身的规则将你的的代码重新格式化，不管你之前的代码风格是怎样的，总之你写完，再用一下这个工具，代码“刷”一下就变了。</p>
<p>在团队合作的项目中，在制定相关规范时，应采取<strong>少数服从多数</strong>规则进行制定，我这套模板主要是用了<a href="https://github.com/airbnb/javascript" target="_blank" rel="external">airbnb</a>的代码规范。</p>
<p>官方文档：</p>
<p><a href="https://eslint.org/" target="_blank" rel="external">Eslint</a></p>
<p><a href="https://prettier.io/" target="_blank" rel="external">Prettier</a></p>
<h2 id="Githook"><a href="#Githook" class="headerlink" title="Githook"></a>Githook</h2><p>有时候好不容易写完业务代码了，好累，测试也 ok，好，直接提交吧，然后没有提交完后发现<strong>忘了用<code>prettier</code>进行代码格式化了！！</strong>所以，<code>Githook</code>可以为我们解决这种情况的发生(Githook，顾名思义，也是就 git 的钩子，在对应的功能中会分别触发)。我这边用<code>husky</code>和<code>lint-staged</code>实现<code>pre-commit</code>钩子管理。也就是在<code>commit</code>代码前，强制使用<code>Eslint</code>和<code>prettier</code>进行代码规范约束和格式化。</p>
<p>安装好模块，在<code>package.json</code>中，只需要添加下面的信息：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"lint-staged"</span>: &#123;</div><div class="line">    <span class="string">"src/**/*.&#123;vue,js&#125;"</span>: [</div><div class="line">      <span class="string">"prettier --write"</span>,</div><div class="line">      <span class="string">"eslint --fix --ext"</span>,</div><div class="line">      <span class="string">"git add"</span></div><div class="line">    ],</div><div class="line">    <span class="string">"src/**/*.&#123;json,md,css,scss&#125;"</span>: [</div><div class="line">      <span class="string">"prettier --write"</span>,</div><div class="line">      <span class="string">"git add"</span></div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"husky"</span>: &#123;</div><div class="line">    <span class="string">"hooks"</span>: &#123;</div><div class="line">      <span class="string">"pre-commit"</span>: <span class="string">"lint-staged"</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果提交在 src 目录下的<code>.vue,.js</code>文件先进行<code>prettier</code>进行代码格式化，再进行<code>eslint</code>的自动修复，最后 add &amp;&amp; commit，如图：</p>
<p><img src="/images/20180923/1.png" alt="pre-commit"></p>
<h2 id="Arcgis-框架-api-语法提示"><a href="#Arcgis-框架-api-语法提示" class="headerlink" title="Arcgis 框架 api 语法提示"></a>Arcgis 框架 api 语法提示</h2><p>想<code>Vue</code>、<code>React</code>这些热门的框架，是拥有非常多的 vscode 语法提示插件的，而<code>Dojo</code>和<code>Arcgis</code>都是偏冷门的框架，我没有找到相关的 api 提示插件。后来我 google 了下发现，可以通过安装<code>@types/arcgis-js-api</code>，<code>@types/dojo</code>这 2 个模块，然后创建一个<code>tsd.d.ts</code>拓展来告诉 vscode：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// &lt;reference path="./node_modules/@types/arcgis-js-api/index.d.ts" /&gt;</span></div><div class="line"><span class="comment">/// &lt;reference path="./node_modules/@types/dojo/index.d.ts" /&gt;js</span></div></pre></td></tr></table></figure>
<p>效果：</p>
<p><img src="/images/20180923/2.png" alt="模块引入提示"></p>
<p>api 提示：</p>
<p><img src="/images/20180923/3.png" alt="api输入提示"></p>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>其实这算是对三个月前技术分享的一些补充，修改一些 bug 的同时也加入了比较多的功能。Vuecli 是搭建前端开发环境的最佳实践，所以继续沿用这套实践方案也是比较好的选择。最近<strong>Vuecli3</strong>也发布 release 版了，webpack 的配置没有像 Vuecli2 那样全部暴露出来，而是封装成插件的形式进行加载，对不需要怎么更改 webpack 配置的开发者来说是非常友好的，但是对于像我们这种需要改比较多 webpack 配置的项目来说，是需要一些学习成本的，如果想更改 webpack 的配置，只能通过<code>webpack.chain</code>插件去修改了。目前还没仔细学习这个插件，所以还需要点时间，以后搞出来了再分享吧(๑•̀ ㅂ•́)و✧，Vuecli3 非常强大，我觉得只要习惯了 Vuecli3，就回不去 Vuecli2 了，这就是所谓的前端就是要紧跟潮流吧，哈哈 😀</p>
<p>国际惯例，附上<a href="https://github.com/shooterRao/arcgis-webpack-vue/tree/vuecli2" target="_blank" rel="external">github 地址</a></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Rao Jinwei</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://shooterblog.site/2018/09/23/Vuecli2引入arcgis-js-api方案总结(非esri-loader方案)/">http://shooterblog.site/2018/09/23/Vuecli2引入arcgis-js-api方案总结(非esri-loader方案)/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明来自 <a href="http://shooterblog.site" target="_blank">Rao Jinwei's Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/webpack/">webpack</a><a class="post-meta__tags" href="/tags/vue/">vue</a><a class="post-meta__tags" href="/tags/arcgis/">arcgis</a></div><elif theme.sharejs && theme.sharejs.enable></elif></article><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/11/04/Vue实践小结(长期更新)/"><i class="fa fa-chevron-left">  </i><span>Vue 实践小结(长期更新)</span></a></div><div class="next-post pull-right"><a href="/2018/07/01/真实案例引发对&quot;js内存泄漏&quot;的一些思考/"><span>真实案例引发对&quot;js内存泄漏&quot;的一些思考</span><i class="fa fa-chevron-right"></i></a></div></nav><elif theme.laibili && theme.laibili.enable></elif><elif theme.gitment && theme.gitment.enable></elif><elif theme.gitalk && theme.gitalk.enable></elif></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2018 By Rao Jinwei</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.4.2"></script><script src="/js/fancybox.js?version=1.4.2"></script><script src="/js/sidebar.js?version=1.4.2"></script><script src="/js/copy.js?version=1.4.2"></script><script src="/js/fireworks.js?version=1.4.2"></script><script src="/js/transition.js?version=1.4.2"></script><script src="/js/scroll.js?version=1.4.2"></script><script src="/js/head.js?version=1.4.2"></script></body></html>