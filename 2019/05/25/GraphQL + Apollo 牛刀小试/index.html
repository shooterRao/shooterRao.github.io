<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="GraphQL + Apollo 牛刀小试"><meta name="keywords" content="GraphQL,Apollo"><meta name="author" content="Rao Jinwei,undefined"><meta name="copyright" content="Rao Jinwei"><title>GraphQL + Apollo 牛刀小试 | Rao Jinwei's Blog</title><link rel="shortcut icon" href="/sl.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.4.2"><script>var GLOBAL = { 
  root: '/',
  algolia: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  localSearch: undefined
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是-GraphQL-？"><span class="toc-number">1.1.</span> <span class="toc-text">什么是 GraphQL ？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查询-Query"><span class="toc-number">1.2.</span> <span class="toc-text">查询 (Query)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#变更-Mutation"><span class="toc-number">1.3.</span> <span class="toc-text">变更 (Mutation)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Schema"><span class="toc-number">1.4.</span> <span class="toc-text">Schema</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Apollo-GraphQL"><span class="toc-number">1.5.</span> <span class="toc-text">Apollo-GraphQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#开始实战"><span class="toc-number">1.6.</span> <span class="toc-text">开始实战</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#搭建服务端"><span class="toc-number">1.6.1.</span> <span class="toc-text">搭建服务端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#客户端搭建"><span class="toc-number">1.6.2.</span> <span class="toc-text">客户端搭建</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-number">1.7.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://avatars1.githubusercontent.com/u/23609695?s=400&amp;u=d2db8f6efdee5add420addf7f89b916f7ef47ca7&amp;v=4"></div><div class="author-info__name text-center">Rao Jinwei</div><div class="author-info__description text-center">追寻生活的影子</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">15</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">17</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">10</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(http://pic1.win4000.com/wallpaper/7/59bb35a6c903f.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Rao Jinwei's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">GraphQL + Apollo 牛刀小试</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-05-25</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/GraphQL/">GraphQL</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div id="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>GraphQL 这门新技术在去年就开始火热起来，今年也在很多技术周刊、论坛上看到关于这门新技术的研究和讨论。因此作为一名前端开发，紧跟技术潮流是必须的 🤣，周末便花了点时间对 GraphQL 进行了相关学习，学习过程中写了一些简单的 demo，在此过程中发现这玩意是真的香啊，所以决定要开篇博客来记录下这个过程。</p>
<a id="more"></a>
<h3 id="什么是-GraphQL-？"><a href="#什么是-GraphQL-？" class="headerlink" title="什么是 GraphQL ？"></a>什么是 GraphQL ？</h3><p>当学习一本新技术时，首先就要去了解这门新技术的定位和一些相关概念，然后就要去研究它的诞生能够解决哪些痛点和带来哪些爽点。我个人习惯是直接去<a href="https://graphql.cn/" target="_blank" rel="external">官方文档</a>找到这些疑问的答案。打开官网，你就看到了下面有很醒目的一句话：</p>
<blockquote>
<p>一种用于 API 的查询语言</p>
</blockquote>
<p>还附加了几句很有意思的话：</p>
<ul>
<li>请求你所要的数据，不多不少</li>
<li>获取多个资源，只用一个请求</li>
<li>描述所有的可能的类型系统</li>
<li>支持多种语言 (js、java、go)</li>
</ul>
<p>说实话我看到这些第一反应就是感觉很酷，但也给我带来了很多疑惑，单从纸面上看还是比较难理解的，没有实际操作的话就很难体会上面说的那些特征。所以我开始了一波学习和 demo 的尝试 🤔</p>
<p>GraphQL 一些关键概念包含 <code>Type</code>，<code>Schema</code>， <code>Query</code>, <code>Mutation</code>等，下面会分别做一下简单的说明，具体还是要结合实际代码进行分析。</p>
<h3 id="查询-Query"><a href="#查询-Query" class="headerlink" title="查询 (Query)"></a>查询 (Query)</h3><p>顺着文档看，首先就看到到了关于<strong>查询</strong>的相关使用，所谓的查询就是向服务端获取你要想的数据，比如我要查所有的用户列表，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">// 先定义 User 数据结构</div><div class="line">type User &#123;</div><div class="line">  id: Int!</div><div class="line">  name: String!</div><div class="line">  age: Int!</div><div class="line">&#125;</div><div class="line"></div><div class="line">// query 查询</div><div class="line">query &#123;</div><div class="line">  // 返回一个User类型的集合</div><div class="line">  userList() : [User!]</div><div class="line">  // 可以传参查询</div><div class="line">  // 根据id查询用户信息</div><div class="line">  orderUser(id: Int!) : User!</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 <code>REST</code> 风格接口应该是这样子的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">GET /api/v1/userList</div><div class="line">GET /api/V1/userList/:id/</div></pre></td></tr></table></figure>
<p>这时候，你会对<code>GraphQL</code>的解析—<strong>查询语言</strong>会有点小小的感触了</p>
<p>还有，<code>query</code>和<code>type</code>的使用息息相关，所以在使用<code>query</code>的时候，一定要先去了解<code>type</code>类型系统，关于<code>type</code>类型系统在<a href="https://graphql.cn/learn/schema/#type-system" target="_blank" rel="external">官网的文档</a> 上已经写得非常详细，这里我就不具体说了</p>
<h3 id="变更-Mutation"><a href="#变更-Mutation" class="headerlink" title="变更 (Mutation)"></a>变更 (Mutation)</h3><p>GraphQL 中的 <code>Mutation</code> 是用来改变服务器上的数据的。对应着 <code>REST</code> 风格中的 <code>PUT</code>,<code>DELETE</code>,<code>POST</code>。<code>Mutation</code>的语法风格和<code>Query</code>很类似。关键在解析<code>Mutation</code>过程中会有所不同。还有值得注意的是，<strong>查询字段时，是并行执行，而变更字段时，是线性执行，一个接着一个。</strong></p>
<p>比如说，我要变更一个用户<code>user</code>的名字</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">mutation &#123;</div><div class="line">  // 通过参数 id 去查到对应的用户信息</div><div class="line">  MutationUserName(id: Int!, name: String!) : User!</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 解析 MutationUserName DEMO</div><div class="line"></div><div class="line">Mutation: &#123;</div><div class="line">  MutationUserName(_, &#123; id, name &#125;) &#123;</div><div class="line">    const user = userList.find(val =&gt; val.id === id);</div><div class="line"></div><div class="line">      if (!user) &#123;</div><div class="line">        throw new Error(`找不到id为 $&#123;id&#125; 的user`);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      user.name = name</div><div class="line"></div><div class="line">      return user;</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h3 id="Schema"><a href="#Schema" class="headerlink" title="Schema"></a>Schema</h3><p>在 GraphQL 中，<code>Schema</code> 主要是用来描述数据的形态，哪些数据能被查询到，所以在 <code>Schema</code> 中主要定义可用数据的数据类型。这么说吧，你想要查到的数据都必须要在 <code>Schema</code> 中进行定义，所以这里是需要写很多 <code>type</code> 的，这里还需要统一定义 <code>Query</code> 和 <code>Mutation</code>，也就是要把上面那些定位全部放到这里来</p>
<p>🌰:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">type User &#123;</div><div class="line">  id: Int!</div><div class="line">  name: String!</div><div class="line">  age: Int!</div><div class="line">&#125;</div><div class="line"></div><div class="line">type Query &#123;</div><div class="line">  userList() : [User]</div><div class="line">  orderUser(id: Int!) : User</div><div class="line">&#125;</div><div class="line"></div><div class="line">mutation &#123;</div><div class="line">  MutationUserName(id: Int!, name: String!) : User</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>很很基础的内容大概就是酱紫，下面应该要开始来一波实战操作了</p>
<h3 id="Apollo-GraphQL"><a href="#Apollo-GraphQL" class="headerlink" title="Apollo-GraphQL"></a>Apollo-GraphQL</h3><blockquote>
<p>Apollo-GraphQL 是基于 GraphQL 封装的一种实现，它可以在服务上进行分层，包括 <code>REST</code> api 和 数据库，它包含客户端和服务端，还有 GUI 开发工具，让开发人员可以快速上手进行开发。</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/apollographql/apollo/HEAD/docs/source/img/platform-diagram.png" alt="架构图"></p>
<p>我在 google 关于 GraphQL 的时候，就发现了这个平台，在官方文档上看到了一些讲解和入门练习。发现其入口门槛其实并不高，安装几个依赖便可快速启动服务端，客户端也支持了 <code>vue</code>、<code>react/rn</code>、<code>ng</code>等热门的前端框架。我这里的 demo 也是根据文档教学一步步做出来的，下面就来讲讲我的 demo 实现过程和一些思路。</p>
<h3 id="开始实战"><a href="#开始实战" class="headerlink" title="开始实战"></a>开始实战</h3><p><strong>具体想法</strong></p>
<ul>
<li>以搭建博客网站为例，有博客列表、分类、博客信息 (query)</li>
<li>点击某个博客，跳转到具体文章内容，返回时有已读标注 (mutation)</li>
<li>服务端使用 apollo-server-express</li>
<li>客户端使用 vue-apollo</li>
<li>数据为 mock 的静态 json</li>
</ul>
<h4 id="搭建服务端"><a href="#搭建服务端" class="headerlink" title="搭建服务端"></a>搭建服务端</h4><p>这边采用 <code>apollo-server-express</code> 快速搭建服务端</p>
<p>首先安装依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yarn add apollo-server-express express graphql</div></pre></td></tr></table></figure>
<p>好，这个 demo 只需要上面三个工具</p>
<p>对于<code>apollo-server</code>，比较基本的就是要搞清楚 <a href="https://www.apollographql.com/docs/tutorial/schema" target="_blank" rel="external">schema</a> 和 <a href="https://www.apollographql.com/docs/tutorial/resolvers" target="_blank" rel="external">resolvers</a> 应该如何定义，这些理解起来还是比较容易，但如果想玩得很溜，肯定需要投入大量的时间去研究。</p>
<p>其实就是</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> server = <span class="keyword">new</span> ApolloServer(&#123;</div><div class="line">  typeDefs,</div><div class="line">  resolvers</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>定义好 typeDefs(schema) 和 resolvers，便可快速启动</p>
<p>首先，把 mock 的数据源定好</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"id"</span>: <span class="number">1</span>,</div><div class="line">    <span class="attr">"title"</span>: <span class="string">"记一次系统前端底层升级总结"</span>,</div><div class="line">    <span class="attr">"date"</span>: <span class="string">"2018-11-11"</span>,</div><div class="line">    <span class="attr">"introduction"</span>: <span class="string">"最近参与了一个比较大的类后台管理系统的前端开发(vue技术栈)，并负责了该系统的底层升级，升级过程期间，遇到了不少问题，在解决问题的过程中学到了很多，趁着今天双11没啥事做，那么就花点时间总结下升级系统的过程吧"</span>,</div><div class="line">    <span class="attr">"category"</span>: <span class="string">"vue"</span>,</div><div class="line">    <span class="attr">"isRead"</span>: <span class="literal">false</span></div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"id"</span>: <span class="number">2</span>,</div><div class="line">    <span class="attr">"title"</span>: <span class="string">"Vue实践小结(长期更新)"</span>,</div><div class="line">    <span class="attr">"date"</span>: <span class="string">"2018-11-04"</span>,</div><div class="line">    <span class="attr">"introduction"</span>: <span class="string">"近期都在用 Vue 全家桶进行项目开发，过程中难免会遇到不少问题，这篇博客主要就是记录开发过程中遇到的问题，和每个问题对应的解决方案。此外，Vue 框架和周边生态会一直更新，以及发布新功能，在实践过程中总会遇到一些所谓的“坑”，我也会把填坑过程记录于此。坑是填不完的，这篇博客也是写不完的。"</span>,</div><div class="line">    <span class="attr">"category"</span>: <span class="string">"vue"</span>,</div><div class="line">    <span class="attr">"isRead"</span>: <span class="literal">false</span></div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"id"</span>: <span class="number">3</span>,</div><div class="line">    <span class="attr">"title"</span>: <span class="string">"如何用Koa2返回文本和图片流以及解决乱码事件"</span>,</div><div class="line">    <span class="attr">"date"</span>: <span class="string">"2018-04-05"</span>,</div><div class="line">    <span class="attr">"introduction"</span>: <span class="string">"前两天做项目的时候，碰到了一个要在客户端(浏览器)中实现预览 txt 文档和图片的小需求，在开发过程中遇到了一些有趣的小插曲---客户端读取 txt 时出现各种奇怪乱码，图片就没问题。一时半会还没找到好的解决方法，因为那天又刚好周五，所以在周末的时候，我决定宅在家里好好研究如何解决这个有趣的现象。"</span>,</div><div class="line">    <span class="attr">"category"</span>: <span class="string">"koa2"</span>,</div><div class="line">    <span class="attr">"isRead"</span>: <span class="literal">false</span></div><div class="line">  &#125;</div><div class="line">][</div><div class="line">  (&#123;</div><div class="line">    <span class="attr">"id"</span>: <span class="number">1</span>,</div><div class="line">    <span class="attr">"html"</span>: <span class="string">"&lt;h1&gt;记一次系统前端底层升级总结&lt;/h1&gt;"</span></div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"id"</span>: <span class="number">2</span>,</div><div class="line">    <span class="attr">"html"</span>: <span class="string">"&lt;h1&gt;Vue实践小结(长期更新)&lt;/h1&gt;"</span></div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"id"</span>: <span class="number">3</span>,</div><div class="line">    <span class="attr">"html"</span>: <span class="string">"&lt;h1&gt;如何用Koa2返回文本和图片流以及解决乱码事件&lt;/h1&gt;"</span></div><div class="line">  &#125;)</div><div class="line">]</div></pre></td></tr></table></figure>
<p>然后，要开始思考如何定义 Schema 中的 type</p>
<p>我这边一共定义了以下这些 type</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">type Article &#123;</div><div class="line">  id: Int!</div><div class="line">  title: <span class="built_in">String</span>!</div><div class="line">  date: <span class="built_in">String</span>!</div><div class="line">  introduction: <span class="built_in">String</span>!</div><div class="line">  category: <span class="built_in">String</span></div><div class="line">  isRead: <span class="built_in">Boolean</span>!</div><div class="line">&#125;</div><div class="line"></div><div class="line">type ArticleContent &#123;</div><div class="line">  id: Int!</div><div class="line">  html: <span class="built_in">String</span>!</div><div class="line">&#125;</div><div class="line"></div><div class="line">type Category &#123;</div><div class="line">  num: Int!,</div><div class="line">  name: <span class="built_in">String</span>!</div><div class="line">&#125;</div><div class="line"></div><div class="line">type Query &#123;</div><div class="line">  fetchArticles: [Article]</div><div class="line">  getAllCategories: [Category]</div><div class="line">  getArticleContent(id: Int!): ArticleContent</div><div class="line">&#125;</div><div class="line"></div><div class="line">type Mutation &#123;</div><div class="line">  articleIsRead(id: Int!): Article</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>把 这些 schema 转换为 typeDefs, 需要用到</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> &#123; gql &#125; = <span class="built_in">require</span>(<span class="string">"apollo-server-express"</span>);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = gql<span class="string">`上面定义的type`</span>;</div></pre></td></tr></table></figure>
<p>定义 resolvers</p>
<p><code>resolvers</code> 其实是 <code>query</code> 和 <code>mutation</code> 的实现过程。也就是说这里会进行数据库的查询或者是 api 的调用等等，最终放回的结果在这里出来。</p>
<p>我这边的实现大概是这样的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> articles = <span class="built_in">require</span>(<span class="string">"../data/articles.json"</span>);</div><div class="line"><span class="keyword">const</span> articleContent = <span class="built_in">require</span>(<span class="string">"../data/articleContent.json"</span>);</div><div class="line"></div><div class="line"><span class="keyword">const</span> resolvers = &#123;</div><div class="line">  Query: &#123;</div><div class="line">    fetchArticles() &#123;</div><div class="line">      <span class="keyword">return</span> articles;</div><div class="line">    &#125;,</div><div class="line">    getAllCategories() &#123;</div><div class="line">      <span class="keyword">return</span> articles.reduce(<span class="function">(<span class="params">pre, cur</span>) =&gt;</span> &#123;</div><div class="line">        <span class="keyword">const</span> cate = pre.find(<span class="function"><span class="params">_</span> =&gt;</span> _.name === cur.category);</div><div class="line">        <span class="keyword">if</span> (cate) &#123;</div><div class="line">          cate.num++;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          <span class="keyword">const</span> obj = &#123;</div><div class="line">            name: cur.category,</div><div class="line">            num: <span class="number">1</span></div><div class="line">          &#125;;</div><div class="line">          pre.push(obj);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> pre;</div><div class="line">      &#125;, []);</div><div class="line">    &#125;,</div><div class="line">    getArticleContent(_, &#123; id &#125;) &#123;</div><div class="line">      <span class="keyword">return</span> articleContent.find(<span class="function"><span class="params">val</span> =&gt;</span> val.id === id);</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  Mutation: &#123;</div><div class="line">    <span class="comment">// 标记已读</span></div><div class="line">    articleIsRead(_, &#123; id &#125;) &#123;</div><div class="line">      <span class="keyword">const</span> article = articles.find(<span class="function"><span class="params">val</span> =&gt;</span> val.id === id);</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (!article) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`找不到id为 <span class="subst">$&#123;id&#125;</span> 的文章`</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (article.isRead) &#123;</div><div class="line">        <span class="keyword">return</span> article;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      article.isRead = <span class="literal">true</span>;</div><div class="line"></div><div class="line">      <span class="keyword">return</span> article;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = resolvers;</div></pre></td></tr></table></figure>
<p>好了，typeDefs 和 resolvers 搞定了，写点服务器启动脚本</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</div><div class="line"><span class="keyword">const</span> &#123; ApolloServer &#125; = <span class="built_in">require</span>(<span class="string">"apollo-server-express"</span>);</div><div class="line"></div><div class="line"><span class="keyword">const</span> typeDefs = <span class="built_in">require</span>(<span class="string">"./schema"</span>);</div><div class="line"><span class="keyword">const</span> resolvers = <span class="built_in">require</span>(<span class="string">"./resolvers"</span>);</div><div class="line"></div><div class="line"><span class="keyword">const</span> PORT = <span class="number">4000</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> app = express();</div><div class="line"></div><div class="line"><span class="keyword">const</span> server = <span class="keyword">new</span> ApolloServer(&#123;</div><div class="line">  typeDefs,</div><div class="line">  resolvers,</div><div class="line">  playground: &#123;</div><div class="line">    endpoint: <span class="string">`/graphql`</span>,</div><div class="line">    settings: &#123;</div><div class="line">      <span class="string">"editor.theme"</span>: <span class="string">"light"</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">server.applyMiddleware(&#123; app &#125;);</div><div class="line"></div><div class="line">app.listen(PORT, () =&gt;</div><div class="line">  <span class="built_in">console</span>.log(</div><div class="line">    <span class="string">`🚀 Server ready at http://localhost:<span class="subst">$&#123;PORT&#125;</span><span class="subst">$&#123;server.graphqlPath&#125;</span>`</span></div><div class="line">  )</div><div class="line">);</div></pre></td></tr></table></figure>
<p>然后 <code>node server.js</code> 一下看看</p>
<p>启动不报错的话，在浏览器<code>http://localhost:4000/graphql</code>可以看到图形化页面</p>
<p><img src="https://img-1257816861.cos.ap-guangzhou.myqcloud.com/gql-ui.png" alt="gql-ui"></p>
<p>试试 query 查询</p>
<p><img src="https://img-1257816861.cos.ap-guangzhou.myqcloud.com/gql-query.png" alt="gql-query"></p>
<p>服务端搭建完成 🎉</p>
<h4 id="客户端搭建"><a href="#客户端搭建" class="headerlink" title="客户端搭建"></a>客户端搭建</h4><p>最近在用 vue 比较多，所以就直接用 <code>vue create xxx</code> 进行一顿操作来弄了，主要也是基于 <a href="https://vue-apollo.netlify.com/zh-cn/guide/" target="_blank" rel="external">vue-apollo 文档</a> 进行学习和编写</p>
<p>安装？</p>
<p><code>yarn add vue-apollo graphql apollo-boost</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">"vue"</span>;</div><div class="line"><span class="keyword">import</span> ApolloClient <span class="keyword">from</span> <span class="string">"apollo-boost"</span>;</div><div class="line"><span class="keyword">import</span> VueApollo <span class="keyword">from</span> <span class="string">"vue-apollo"</span>;</div><div class="line"></div><div class="line">Vue.use(VueApollo);</div><div class="line"></div><div class="line"><span class="keyword">const</span> apolloClient = <span class="keyword">new</span> ApolloClient(&#123;</div><div class="line">  <span class="comment">// 你需要在这里使用绝对路径</span></div><div class="line">  uri: <span class="string">"http://localhost:4000/graphql"</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">const</span> apolloProvider = <span class="keyword">new</span> VueApollo(&#123;</div><div class="line">  defaultClient: apolloClient</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">new</span> Vue(&#123;</div><div class="line">  el: <span class="string">"#app"</span>,</div><div class="line">  apolloProvider,</div><div class="line">  render: <span class="function"><span class="params">h</span> =&gt;</span> h(App)</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>就是这么简单 😁</p>
<p>使用？</p>
<p>来试一下查询多个数据，比如说一起查询博客文章列表和分类信息。验证一下是不是官方说的<strong>获取多个资源，只用一个请求</strong>那么神奇</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> gql <span class="keyword">from</span> <span class="string">"graphql-tag"</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> fetchDataGql = gql<span class="string">`</span></div><div class="line"><span class="string">  &#123;</span></div><div class="line"><span class="string">    fetchArticles &#123;</span></div><div class="line"><span class="string">      id</span></div><div class="line"><span class="string">      title</span></div><div class="line"><span class="string">      date</span></div><div class="line"><span class="string">      introduction</span></div><div class="line"><span class="string">      category</span></div><div class="line"><span class="string">      isRead</span></div><div class="line"><span class="string">    &#125;</span></div><div class="line"><span class="string">    getAllCategories &#123;</span></div><div class="line"><span class="string">      num</span></div><div class="line"><span class="string">      name</span></div><div class="line"><span class="string">    &#125;</span></div><div class="line"><span class="string">  &#125;</span></div><div class="line"><span class="string">`</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</div><div class="line">  data() &#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">      articles: [],</div><div class="line">      categories: []</div><div class="line">    &#125;;</div><div class="line">  &#125;,</div><div class="line">  apollo: &#123;</div><div class="line">    fetchData() &#123;</div><div class="line">      <span class="keyword">const</span> vm = <span class="keyword">this</span>;</div><div class="line">      <span class="keyword">return</span> &#123;</div><div class="line">        query: fetchDataGql,</div><div class="line">        update(data) &#123;</div><div class="line">          vm.articles = data.fetchArticles;</div><div class="line">          vm.categories = data.getAllCategories;</div><div class="line">        &#125;</div><div class="line">      &#125;;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>打开浏览器控制台</p>
<p><img src="https://img-1257816861.cos.ap-guangzhou.myqcloud.com/vue-gql-query.png" alt="vue-gql-query"></p>
<p>确实是只有一次请求就能获取到一个页面上所有的资源！最近在做项目的时候，遇到一个页面要请求 5 个<code>REST</code>接口，有些接口经常返回了很多页面上用不到的，简单来说就是多余的数据，这样不仅浪费了服务器资源，前后端对接起来也不方便，所以 GraphQL 可以很好地解决这个痛点，真是香啊!</p>
<p>ui 界面上随便写点</p>
<p><img src="https://img-1257816861.cos.ap-guangzhou.myqcloud.com/vue-apollo-article.png" alt="vue-apollo-article"></p>
<p>好了，查询搞定了，下面试试 变更<code>mutation</code></p>
<p>需求是点击某篇文章，让这篇文章的 title 有个已读标识(opacity: 0.4)</p>
<p>服务端那边已经定义好，客户端代码核心实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> mArticleISRead = gql<span class="string">`</span></div><div class="line"><span class="string">  mutation articleIsRead($id: Int!) &#123;</span></div><div class="line"><span class="string">    articleIsRead(id: $id) &#123;</span></div><div class="line"><span class="string">      id</span></div><div class="line"><span class="string">      title</span></div><div class="line"><span class="string">      date</span></div><div class="line"><span class="string">      introduction</span></div><div class="line"><span class="string">      category</span></div><div class="line"><span class="string">      isRead</span></div><div class="line"><span class="string">  &#125;</span></div><div class="line"><span class="string">&#125;</span></div><div class="line"><span class="string">`</span></div><div class="line">methods: &#123;</div><div class="line">  mutationIsRead(id) &#123;</div><div class="line">    <span class="keyword">this</span>.$apollo.mutate(&#123;</div><div class="line">      mutation: mArticleISRead,</div><div class="line">      variables: &#123;</div><div class="line">        id</div><div class="line">      &#125;,</div><div class="line">      update: <span class="function">(<span class="params">store, &#123; data: &#123; articleIsRead &#125; &#125;</span>) =&gt;</span> &#123;</div><div class="line">        <span class="built_in">console</span>.log(articleIsRead);</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<p>模板层增加一些判断</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">router-link</span></span></div><div class="line"><span class="tag">    <span class="attr">:class</span>=<span class="string">"&#123;isRead: item.isRead&#125;"</span></span></div><div class="line"><span class="tag">    @<span class="attr">click.native</span>=<span class="string">"mutationIsRead(item.id)"</span></span></div><div class="line"><span class="tag">    <span class="attr">:to</span>=<span class="string">"&#123; name: 'content', params: &#123; id: item.id &#125; &#125;"</span></span></div><div class="line"><span class="tag">&gt;</span>&#123;&#123; item.title &#125;&#125;<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></div></pre></td></tr></table></figure>
<p>测试</p>
<p><img src="https://img-1257816861.cos.ap-guangzhou.myqcloud.com/vue-apollo-mutation.png" alt="vue-apollo-mutation"></p>
<p>done！</p>
<p>写到这里，让我感觉好奇的是，我重新跳转回 article 页面，<strong>并没有重新触发 ajax 请求</strong>，后来看了文档才发现这是由于 Apollo-GraphQL 自带了运行时的 <a href="https://www.apollographql.com/docs/react/recipes/performance#cache-redirects" target="_blank" rel="external">cache</a>，变更数据的某个字段是不需要重新去获取最新的列表的，Apollo会智能去识别然后自动触发视图的render。这样的话，我在想，这样既然了 Apollo 的缓存机制，是不是就不需要像 vuex、redux、mobX 这些状态管理工具了呢？毕竟都是运行时的数据，如果 Apollo 的 cache 机制能解决状态管理层面上的问题，那么会减少很多项目层级的复杂度吧。凭空想是想不出的，只有在实际项目中才能找到真正的答案。</p>
<p>好了，GraphQL 的服务端和客户端均已搭建，一些自身的想法也得到了相关印证，不断探索、不断验证想法正是学习的一种乐趣😁</p>
<p>上面代码均已上传到 <a href="https://github.com/shooterRao/GraphQL-demo" target="_blank" rel="external">github</a> </p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>GraphQL 牛刀小试结束。关于 GraphQL 以后能不能取代 RESTapi 还是一个很富有争议的话题。REST已经发展多年，它解决了以前的不少问题但也留下了不少问题，GraphQL 还是比较新的，相信还有很多人都不知道有这个技术，即使它已诞生了好多年…还是那句话，每个新的技术的诞生，必然是为了解决某些问题，以及提高生产效率，这样才有它们存在的价值和意义。</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Rao Jinwei</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://shooterblog.site/2019/05/25/GraphQL + Apollo 牛刀小试/">http://shooterblog.site/2019/05/25/GraphQL + Apollo 牛刀小试/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明来自 <a href="http://shooterblog.site" target="_blank">Rao Jinwei's Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/GraphQL/">GraphQL</a><a class="post-meta__tags" href="/tags/Apollo/">Apollo</a></div><elif theme.sharejs && theme.sharejs.enable></elif></article><nav id="pagination"><div class="next-post pull-right"><a href="/2018/11/11/记一次系统前端底层升级总结/"><span>记一次系统前端底层升级总结</span><i class="fa fa-chevron-right"></i></a></div></nav><elif theme.laibili && theme.laibili.enable></elif><elif theme.gitment && theme.gitment.enable></elif><elif theme.gitalk && theme.gitalk.enable></elif></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2019 By Rao Jinwei</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.4.2"></script><script src="/js/fancybox.js?version=1.4.2"></script><script src="/js/sidebar.js?version=1.4.2"></script><script src="/js/copy.js?version=1.4.2"></script><script src="/js/fireworks.js?version=1.4.2"></script><script src="/js/transition.js?version=1.4.2"></script><script src="/js/scroll.js?version=1.4.2"></script><script src="/js/head.js?version=1.4.2"></script></body></html>