---
title: ä¼ä¸šçº§å‰ç«¯è„šæ‰‹æ¶å¼€å‘æ€»ç»“
date: 2020-07-09
tags: [è„šæ‰‹æ¶,å‰ç«¯å·¥ç¨‹åŒ–]
categories: [è„šæ‰‹æ¶]
---

## ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦å‰ç«¯è„šæ‰‹æ¶

> è„šæ‰‹æ¶æ˜¯ä¸ºäº†ä¿è¯å„æ–½å·¥è¿‡ç¨‹é¡ºåˆ©è¿›è¡Œè€Œæ­è®¾çš„å·¥ä½œå¹³å°ã€‚

ç›¸ä¿¡å¾ˆå¤šå‰ç«¯ç«¥é‹éƒ½ç”¨è¿‡`vue-cli`ã€`create-react-app`è¿™ç±»ä¼˜ç§€çš„å‰ç«¯è„šæ‰‹æ¶äº†ï¼Œè¿™äº›å·¥å…·åœ¨ä¸€å®šç¨‹åº¦ä¸Šæå‡äº†æˆ‘ä»¬é¡¹ç›®åˆå§‹åŒ–çš„æ•ˆç‡ï¼Œå‡å°‘äº†å¾ˆå¤šé‡å¤æ€§çš„å·¥ä½œï¼Œä½†è¿™äº›å·¥å…·ä»…ä»…æ˜¯åŸºç¡€é€šç”¨å‹çš„ï¼Œè·Ÿå…¬å¸ä¸šåŠ¡ä»¥åŠå†…éƒ¨åˆ¶å®šçš„è§„èŒƒæ— å…³ï¼Œå¯æ§æ€§ä¸é«˜ï¼Œè¿œè¿œä¸èƒ½æ»¡è¶³å…¬å¸çš„éœ€æ±‚ã€‚æ‰€ä»¥ï¼Œä¸ºäº†æ»¡è¶³å…¬å¸å†…éƒ¨çš„ç ”å‘éœ€æ±‚ï¼Œè§„èŒƒé¡¹ç›®ç»“æ„ä»¥åŠæé«˜æ¯ä¸ªå‰ç«¯çš„åŒå­¦çš„å·¥ä½œæ•ˆç‡ï¼Œä¾¿éœ€è¦æœ‰ä¸€å¥—å†…éƒ¨çš„å‰ç«¯è„šæ‰‹æ¶æ¥æ”¯æŒï¼ŒæœåŠ¡æ¯ä¸ªå¼€å‘äººå‘˜ï¼Œèµ‹èƒ½å…¬å¸æ‰€æœ‰çš„é¡¹ç›®ğŸš€

## éœ€è¦è€ƒè™‘ä»€ä¹ˆ

ç›®å‰é¡¹ç›®ä¸Šå­˜åœ¨ä»¥ä¸‹è¿™äº›ç—›ç‚¹ï¼š

- å‰ç«¯é¡¹ç›®è¶Šæ¥è¶Šé‡ï¼Œä¸€äº›å·¥å…·é›†æˆå¾ˆç¹çã€è€—æ—¶ï¼Œå¦‚`commitlint`
- é¡¹ç›®ç»“æ„ä¸å¤Ÿç»Ÿä¸€ï¼Œä»…ä»…é `vuecli`æ¥åˆå§‹åŒ–é¡¹ç›®è¿œè¿œä¸å¤Ÿ
- ä¸æƒ³æ¯æ¬¡é¡¹ç›®åˆå§‹åŒ–éƒ½`yarn add`ä¸€å †ä¾èµ–
- å‰ç«¯é¡¹ç›®ç±»å‹å¤šï¼Œä¸åŒé¡¹ç›®é…ç½®ä¸åŒï¼Œç®¡ç†æˆæœ¬é«˜
- å•é `git clone`åŸºçº¿è¿™äº›æ–¹å¼ä¸æ–¹ä¾¿

è§£å†³è¿™äº›ç—›ç‚¹æœ€æ ¸å¿ƒçš„ä¸€ä¸ªæ–¹æ¡ˆå°±æ˜¯ï¼Œé€šè¿‡å®šåˆ¶å¤šå¥—æ¨¡æ¿ï¼Œç„¶åç”¨è„šæ‰‹æ¶å»æ‹‰å–æ¨¡æ¿è¿›è¡Œé¡¹ç›®åˆå§‹åŒ–ã€‚ä½†æ˜¯è¦åšå¥½è¿™å¥—æ–¹æ¡ˆï¼Œä¹Ÿæœ‰å¾ˆå¤šç»†èŠ‚éœ€è¦è®¨è®ºçš„ï¼Œæ¯”å¦‚ï¼š

- æ¨¡æ¿æ”¯æŒæ‹“å±•
- é›¶æˆæœ¬æ¥å…¥æ–°æ¨¡æ¿
- æ ¹æ®ç”¨æˆ·é€‰æ‹©ï¼Œç”Ÿæˆå®šåˆ¶åŒ–æ¨¡æ¿
- å‹å¥½çš„ç•Œé¢äº¤äº’
- ...

é™¤æ­¤ä¹‹å¤–ï¼Œæ‹‰å–é¡¹ç›®åªæ˜¯è„šæ‰‹æ¶çš„ä¸€ä¸ªåŠŸèƒ½è€Œå·²ï¼Œæˆ‘ä»¬æœŸæœ›è„šæ‰‹æ¶æ˜¯ä¸€ä¸ªæ•ˆç‡å·¥å…·ï¼Œè€Œä¸åªæ˜¯ç”¨æ¥æ‹‰å–é¡¹ç›®æ¨¡æ¿è¿™ä¹ˆç®€å•ï¼Œæˆ‘ä»¬å¸Œæœ›è„šæ‰‹æ¶æä¾›æ›´å¤šçš„åŠŸèƒ½æ”¯æŒï¼Œæ¯”å¦‚ï¼š

- é›†æˆé¡¹ç›®ä¸Šå’Œå„ä¸ªå‰ç«¯å›¢é˜Ÿå·²æœ‰çš„`node script`
- åœ¨æ—§é¡¹ç›®ä¸Šä¸€é”®åˆå§‹åŒ–vscodeå¼€å‘ç¯å¢ƒ
- åœ¨æ—§é¡¹ç›®ä¸Šé›†æˆ`cz-customizable`
- è„šæ‰‹æ¶å‡çº§æç¤º
- ...

æ‰€ä»¥ï¼Œè„šæ‰‹æ¶æ›´åƒæ˜¯ä¸€å¥—**å‘½ä»¤é›†**ï¼Œä½¿ç”¨`nodejs`æä¾›çš„apiï¼Œå¿«é€Ÿæ¥å…¥å„ç§è‡ªå®šä¹‰å‘½ä»¤ï¼Œè°ƒç”¨ä¾¿å¯è¾¾åˆ°å„ç§ç›®çš„ã€‚

## xcliçš„è¯ç”Ÿ

å¼€ä¼šè®¨è®ºï¼Œç¡®å®šå¥½å½“å‰éœ€æ±‚ï¼Œæˆ‘å°±å¼€å§‹åŠ¨å·¥äº†ã€‚è¦åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯ï¼Œè¿™ä¸ªè„šæ‰‹æ¶å«ä»€ä¹ˆåå­—å‘¢ï¼Ÿæƒ³åˆ°æˆ‘æ‰€æœ‰åœ¨å›¢é˜Ÿå«**xdata**ï¼Œå°±æ‰“ç®—å–`xdata-cli`ï¼Œåæ¥è·Ÿå®‹å“¥è®¨è®ºäº†ä¸‹ï¼Œå†³å®šæ”¹å«`xcli` äº†ï¼Œå› ä¸ºç”¨èµ·æ¥å¯ä»¥æ›´å¿«é€Ÿï¼Œå°‘æ•²å‡ ä¸ªå­—å˜›ğŸ˜€ã€‚ç›®å‰å…¬å¸è¿™å¥—è„šæ‰‹æ¶æ•´ä½“æ¶æ„å·²ç»æ­å»ºå®Œæ¯•ï¼Œä¸Šé¢æåˆ°çš„éœ€æ±‚ä¹Ÿå·²åŸºæœ¬å®ç°ï¼Œä¸‹é¢å°±æ¥è·Ÿå¤§å®¶èŠèŠè¿™å¥—è„šæ‰‹æ¶æŠ€æœ¯æ–¹é¢çš„å†…å®¹ã€‚

### æŠ€æœ¯é€‰å‹

å¼€å‘è¯­è¨€è¿™è¾¹ä½¿ç”¨`typeScript`ï¼Œtsçš„å¥½å¤„ä¸ç”¨å¤šè¯´äº†ï¼Œå†µä¸”è¿˜æœ‰vscodeçš„åŠ æŒï¼Œå†™èµ·æ¥ä½“éªŒéå¸¸niceã€‚ä¸‹é¢æ˜¯å…·ä½“é€‰å‹ï¼š

- node.js >= 10
- typeScript
- eslint
- prettier
- ts-jest
- husky
- lint-staged

é™¤æ­¤ä¹‹å¤–ï¼Œnodejsç”Ÿæ€æä¾›äº†å¾ˆå¤šä¼˜ç§€çš„å¼€æºå·¥å…·åº“ï¼Œè¿™äº›åº“éƒ½éå¸¸é€‚åˆç”¨æ¥è„šæ‰‹æ¶çš„å¼€å‘ï¼Œå…¶å®`vuecli`è¿™äº›å¤§åé¼é¼çš„å¼€æºåº“ï¼Œä¹Ÿæ˜¯ä¾èµ–è¿™ç±»å¼€æºåº“è¿›è¡Œå¼€å‘çš„ã€‚ä¸‹é¢æ˜¯ä½¿ç”¨çš„å¼€æºåº“

- commander (è§£æå‘½ä»¤)

- fs-extra (fsæ¨¡å—æ‹“å±•)
- execa (better child_process)
- download-git-repo (ä¸‹è½½gitä»“åº“å·¥å…·)
- boxen (ç»ˆç«¯ä¸­æ–¹æ¡†è¾“å‡º)
- cfonts (ç»ˆç«¯ç‚«é…·çš„å­—ä½“è¾“å‡º)
- chalk (ç»™æ–‡å­—å¢åŠ è‰²å½©)
- ora (loadingå·¥å…·)
- handlebars (æ¨¡æ¿æ’å€¼)
- module-alias (æ¨¡æ¿åˆ«åæ˜ å°„)
- inquirer (äº¤äº’å¼è¯¢é—®å¹¶è®°å½•ç»“æœ)
- listr (å¤šä»»åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œå¹¶æä¾›loadingæ•ˆæœ)

æœ‰äº†è¿™äº›å¼€æºåº“çš„æ”¯æŒï¼Œè„šæ‰‹æ¶å¼€å‘èµ·æ¥çœŸçš„æ–¹ä¾¿å¤šäº†

### é¡¹ç›®ç»“æ„

ç›®å‰çš„é¡¹ç›®ç»“æ„æ˜¯è¿™æ ·çš„

```
â”œâ”€â”€ bin
â”‚   â””â”€â”€ index.js                  å…¥å£æ–‡ä»¶
â”œâ”€â”€ dist                          ç”Ÿäº§æ–‡ä»¶
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ utils                     å·¥å…·é›†
â”‚   â”œâ”€â”€ commit                    xcli commit
â”‚   â”œâ”€â”€ create                    xcli create
â”‚   â”œâ”€â”€ initenv                   xcli initenv
â”‚   â”œâ”€â”€ script                    xcli script
â”‚   â”œâ”€â”€ update                    xcli update
â”‚   â”œâ”€â”€ types
â”‚   â”œâ”€â”€ unExpectInput.ts          xcli
â”‚   â”œâ”€â”€ updateNotify.ts           é€šçŸ¥æ›´æ–°
â”‚   â”œâ”€â”€ commands.ts               æ³¨å†Œå‘½ä»¤å…¥å£
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ tests                         å•å…ƒæµ‹è¯•
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ jest.config.js
â”œâ”€â”€ rmrf.js
â”œâ”€â”€ package.json
â””â”€â”€ yarn.lock
```

![image-20200825133539595](https://img-1257816861.cos.ap-guangzhou.myqcloud.com/blog/image-20200825133539595.png)

ä¸Šæ–‡å·²ç»æåˆ°è„šæ‰‹æ¶å…¶å®å°±æ˜¯å‘½ä»¤çš„é›†åˆï¼Œä¸€åˆ‡çš„åŠŸèƒ½ä½¿ç”¨éƒ½ç¦»ä¸å¼€å‘½ä»¤ç›¸å…³æ“ä½œï¼Œæ‰€ä»¥è¿™è¾¹å°±é‡‡ç”¨å¹³é“ºçš„æ–¹å¼æ¥ç®¡ç†æ¯ä¸ªå‘½ä»¤é›†ï¼Œä¹Ÿå°±æ˜¯ç”¨æ–‡ä»¶å¤¹çš„æ–¹å¼æ¥ç®¡ç†æ¯ä¸ªå‘½ä»¤ï¼Œæ¯”å¦‚`create`ã€`commit`ç­‰ç­‰è¿™äº›ï¼Œè¿™äº›å°±å¯ä»¥æŠŠå…·ä½“å®ç°çš„æ–‡ä»¶éƒ½æ”¾åˆ°å¯¹åº”çš„æ–‡ä»¶å¤¹è¿›è¡Œç»´æŠ¤å’Œè¿­ä»£å¼€å‘äº†ã€‚

### å…·ä½“å®ç°

#### binæ–‡ä»¶

æ‰€è°“çš„binå…¥å£æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯å¯æ‰§è¡Œçš„æ–‡ä»¶ï¼Œåœ¨`package.json`é…ç½®ä¹‹åï¼Œnpmä¼šæ‰¾åˆ°å¯¹åº”çš„å¯æ‰§è¡Œæ–‡ä»¶çš„ä½ç½®ï¼Œç„¶ååœ¨`node_modules/.bin`ç›®å½•ä¸‹å»ºç«‹å¯¹åº”çš„ç¬¦åˆé“¾æ¥ã€‚æ¯”å¦‚æˆ‘ä»¬åœ¨å®‰è£…æŸäº›åº“çš„æ—¶å€™ï¼Œåœ¨`node_modules`é‡Œä¼šçœ‹åˆ°æ–°å¢çš„ç¬¦åˆé“¾æ¥æ–‡ä»¶

![image-20200825101142818](https://img-1257816861.cos.ap-guangzhou.myqcloud.com/blog/image-20200825101142818.png)

è¿™æ ·å°±å¯ä»¥é€šè¿‡`node_modules/.bin/xxx`æ–¹å¼ç›´æ¥ä½¿ç”¨æŸä¸ªå‘½ä»¤ã€‚å½“ç”¨`npm i -g xxx`æ–¹å¼å®‰è£…å…¨å±€åŒ…çš„è¯ï¼Œå…¨å±€åŒ…ä¼šè¢«å®‰è£…åˆ°`{prefix}/lib/node_modules/`ä¸­ï¼Œä¹Ÿå°±æ˜¯`npm`å…¨å±€`node_modules` ï¼Œå…¶ä¸­ï¼Œ`npm`è¿˜ä¼šåœ¨`{prefix}/bin/`æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªç¬¦åˆé“¾æ¥ï¼Œåœ¨ä½¿ç”¨`xxx`å…¨å±€å‘½ä»¤çš„æ—¶å€™ï¼Œä¹Ÿä¼šåœ¨è¿™ä¸ª`bin`æ–‡ä»¶å¤¹è¿›è¡Œå‘½ä»¤çš„æŸ¥æ‰¾å’Œæ‰§è¡Œï¼Œä¾‹å¦‚æˆ‘ä»¬ç†Ÿæ‚‰çš„`vuecli`ä½¿ç”¨æ–¹å¼ï¼ŒåŸç†ä¹Ÿæ˜¯ä¸€æ ·ï¼Œæˆ‘ä»¬åœ¨å®‰è£…å®Œ`vuecli`åï¼Œåœ¨å…¨å±€`bin`æ–‡ä»¶å¤¹ä¸­ç¡®å®èƒ½æ‰¾åˆ°`vue`çš„ç¬¦åˆé“¾æ¥

![image-20200825105733018](https://img-1257816861.cos.ap-guangzhou.myqcloud.com/blog/image-20200825105733018.png)

é‚£ä¹ˆé—®é¢˜åˆæ¥äº†ï¼Œæ€ä¹ˆåœ¨`package.json`ä¸­è¿›è¡Œbinæ–‡ä»¶é…ç½®å‘¢ï¼Ÿ

å¾ˆç®€å•

```json
{
	"bin": {
   	"xcli": "bin/index.js"
  }
}
```

å†æ‰§è¡Œä¸‹`yarn link`æˆ–è€…`npm link`å°±å¯ä»¥æŠŠ`xcli`çš„binæ–‡ä»¶é“¾æ¥åˆ°å…¨å±€`npm`binæ–‡ä»¶å¤¹ä¸Šå•¦ï¼Œè¿™æ ·åœ¨ç»ˆç«¯ä¸Šè·‘`xcli`å°±èƒ½æ‰§è¡Œ`bin/index.js`æ–‡ä»¶äº†ï¼

#### index.js

ä¸Šæ–‡è¯´äº†ï¼Œ`xcli`æ‰§è¡Œå®é™…ä¸Šå°±æ˜¯è·‘çš„`bin/index.js`æ–‡ä»¶ï¼Œå…ˆæ¥çœ‹çœ‹`index.js`æ–‡ä»¶åšäº†ä»€ä¹ˆ

```js
#!/usr/bin/env node

const currentNodeVersion = process.versions.node;
const semver = currentNodeVersion.split('.');
const major = semver[0];

const Cfonts = require('cfonts');

// Nodeç‰ˆæœ¬æ ¡éªŒ
if (+major < 10) {
  console.log(
    'æ‚¨åœ¨ä½¿ç”¨ Node ' +
      currentNodeVersion +
      '.\n' +
      'xcli éœ€è¦ Node >= 10.0 ç‰ˆæœ¬. \n' +
      'è¯·å‡çº§ Node ç‰ˆæœ¬ï¼.'
  );
  process.exit(1);
}

Cfonts.say('xcli', {
  font: 'block', // define the font face
  align: 'left', // define text alignment
  colors: ['system'], // define all colors
  background: 'transparent', // define the background color, you can also use `backgroundColor` here as key
  letterSpacing: 1, // define letter spacing
  lineHeight: 1, // define the line height
  space: true, // define if the output text should have empty lines on top and on the bottom
  maxLength: '0', // define how many character can be on one line
  gradient: ['blue', 'red'], // define your two gradient colors
  independentGradient: false, // define if you want to recalculate the gradient for each new line
  transitionGradient: false, // define if this is a transition between colors directly
  env: 'node',
});

require('../dist/src/index');
```

å…¶ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šå¯¹`nodejs`çš„ç‰ˆæœ¬è¿›è¡Œä¸€æ¬¡æ ¡éªŒï¼Œå¦‚æœ`node`ç‰ˆæœ¬å°äº10ï¼Œé‚£ä¹ˆå°±ç›´æ¥é€€å‡ºç¨‹åºã€‚ä¸‹é¢è¿˜ç”¨äº†`Cfonts`åšäº†å±‚æ¯”è¾ƒç‚«é…·çš„æ–‡å­—æ•ˆæœï¼Œè®©åˆæ¬¡ä½¿ç”¨çš„ç”¨æˆ·èƒ½æœ‰çœ¼å‰ä¸€äº®çš„æ•ˆæœï¼Œä¸è‡³äºè§‰å¾—å¹³ä¹æ— å‘³ğŸ˜ï¼Œä¸‹é¢æ˜¯ä½¿ç”¨`xcli`çš„æ¼”ç¤ºæ•ˆæœ

![image-20200825111552683](https://img-1257816861.cos.ap-guangzhou.myqcloud.com/blog/image-20200825111552683.png)

è¯·æ³¨æ„ä¸Šé¢ä»£ç æœ€åä¸€å¥`require('../dist/src/index');`ï¼Œè¿™é‡Œç›´æ¥æ‹¿äº†`dist`ä¸‹çš„å…¥å£æ–‡ä»¶è·‘äº†ï¼Œå…¶å®è¿™ä¸ªå°±æ˜¯`ts`ç¼–è¯‘åçš„ä»£ç ï¼Œå› ä¸º`node`æ˜¯è·‘ä¸äº†`ts`ä»£ç çš„ï¼Œé™¤éä½¿ç”¨`ts-node`ï¼Œä½†æ˜¯è¿™è¾¹æš‚æ—¶ä¸è€ƒè™‘ä½¿ç”¨ï¼Œæ‰€ä»¥å°±ç›´æ¥ç”¨äº†è¿™ç§æ–¹å¼ã€‚

`dist/src/index.js`å…¶å®å°±æ˜¯å¯¹åº”ç€`src/index.ts`æ–‡ä»¶ï¼Œåœ¨è¿™å—ï¼Œä¸»è¦æ˜¯è´Ÿè´£æ³¨å†Œå‘½ä»¤ã€æ£€æµ‹ç‰ˆæœ¬å’Œæ›´æ–°é€šçŸ¥çš„æ¨¡å—æ‰§è¡Œã€‚

#### æ³¨å†Œcommands

æ³¨å†Œ`commands`å…¶å®æ˜¯é€šè¿‡[commander](https://github.com/tj/commander.js#readme)è¿™ä¸ªå¼€æºåº“è¿›è¡Œå‘½ä»¤æ³¨å†Œï¼Œä½¿ç”¨æ–¹å¼çœ‹æ–‡æ¡£ï¼Œè¿™è¾¹ä¸åšå…·ä½“ä»‹ç»ã€‚

ä»£ç å®ç°ï¼š

```ts
import program from 'commander';

export default function commands(): void {
  /**
   * åˆ›å»ºé¡¹ç›®
   */
  program
    .command('create [projectName]') // <xxx> å¿…å¡«ï¼Œ[xxx] å¯å¡«)
    .alias('c')
    .description('åˆ›å»ºé¡¹ç›®')
    .action((name) => {
      import('@/create').then((m) => m.default(name));
    });
  
  // çœç•¥ininenvã€commitç­‰...
  
  /**
   * ä»€ä¹ˆå‚æ•°éƒ½ä¸è¾“å…¥ï¼Œç›´æ¥è¾“å…¥ xcli
   */
  program
    .allowUnknownOption()
    .action(() => import('@/unExpectInput').then((m) => m.default()));
}
```

å¯ä»¥çœ‹åˆ°ï¼Œè¿™è¾¹ä¸»è¦æ˜¯ç”¨äº†`commander`è¿›è¡Œäº†å‘½ä»¤æ³¨å†Œï¼Œéå¸¸ç®€æ´æ–¹ä¾¿ã€‚å…¶ä¸­ï¼Œæ³¨å†Œçš„æ¨¡æ¿ç”¨äº†**æŒ‰éœ€åŠ è½½**æ–¹å¼è¿›è¡ŒåŠ è½½ï¼Œè€Œä¸æ˜¯åœ¨æ³¨å†Œå‰å°±æŠŠæ¨¡æ¿åŠ è½½è¿›æ¥ï¼Œç”¨æŒ‰éœ€åŠ è½½çš„å¥½å¤„å°±æ˜¯å¯ä»¥**åŠ å¿«è„šæ‰‹æ¶å¯åŠ¨é€Ÿåº¦**ï¼Œç”¨æˆ·ä½¿ç”¨åˆ°äº†æŸä¸ªå‘½ä»¤å†å»åŠ è½½å¯¹åº”çš„æ¨¡å—ä»£ç ï¼Œæ¯”å¦‚æˆ‘ä½¿ç”¨äº†`xcli create`å†å»åŠ è½½createæ–‡ä»¶å¤¹ä¸‹çš„ç›¸å…³ä»£ç ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œè¿™è¾¹ä½¿ç”¨äº†`program.allowUnknownOption()`æ¥æ”¯æŒè¾“å…¥`xcli`ç›´æ¥å¯åŠ¨ã€‚è¿™æ ·çš„å¥½å¤„ä¸€æ˜¯å¯ä»¥å°‘æ‰“ç‚¹å­—å¿«é€Ÿå¯åŠ¨ï¼ŒäºŒæ˜¯å¯ä»¥è®©ç”¨æˆ·çœ‹çœ‹è¿™ä¸ªè„šæ‰‹æ¶èƒ½å¹²å˜›ï¼Œä¹Ÿä¸ç”¨è®°ä½æ¯ä¸ªå…·ä½“çš„å‘½ä»¤äº†ï¼Œè¿™ç§æ–¹å¼æ¯”è®¾ç½®å‘½ä»¤åˆ«åæ›´åŠ æ–¹ä¾¿ã€‚

#### xcli create

å½“æ—¶æˆ‘åšä¸ªè„šæ‰‹æ¶ï¼Œç¬¬ä¸€ä¸ªåŠŸèƒ½å°±æ˜¯è¦å®ç°æ‹‰å–é¡¹ç›®æ¨¡æ¿ã€‚`xcli create`ä¾¿æ˜¯è¿™ä¸ªéœ€æ±‚çš„å…·ä½“å®ç°ã€‚ä¸‹é¢æ˜¯è¿™ä¸ªåŠŸèƒ½çš„æµç¨‹å›¾

![image-20200825145157032](https://img-1257816861.cos.ap-guangzhou.myqcloud.com/blog/image-20200825145157032.png)

è¿™è¾¹ä¸»è¦çš„æ ¸å¿ƒå®ç°ï¼Œå…¶å®å°±æ˜¯ç”¨`inquirer`åº“æ¥å®ç°äº¤äº’å¼è¯¢é—®æ•ˆæœï¼Œè¿™ä¸ªåº“æ–‡æ¡£è¯¦ç»†ï¼Œå®˜æ–¹è¿˜æä¾›äº†å¾ˆå¤šç¤ºä¾‹ï¼Œå¯ä»¥[åœ¨è¿™](https://github.com/SBoudrias/Inquirer.js#examples)è¿›è¡Œå­¦ä¹ ã€‚

æ‹‰å–æ¨¡æ¿çš„è¯ï¼Œä¼šä½¿ç”¨`gitlab api`å»æ‹‰å–æ¨¡æ¿ç»„ï¼Œç„¶åå–å‡ºæ•°ç»„æä¾›ç»™ç”¨æˆ·è¿›è¡Œé€‰æ‹©ä¸‹è½½ï¼Œè¿™æ ·å°±éå¸¸ä¾¿äº**æ¨¡æ¿çš„æ‹“å±•**ï¼Œå¦‚æœä»¥åæœ‰äº†æ–°çš„æ¨¡æ¿ï¼Œé‚£ä¹ˆä¹Ÿä¸éœ€è¦ä¿®æ”¹è„šæ‰‹æ¶ä»£ç äº†ã€‚

![image-20200825154319837](https://img-1257816861.cos.ap-guangzhou.myqcloud.com/blog/image-20200825154319837.png)

ä½¿ç”¨äº†`listr`ç®¡ç†ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ”¯æŒ`promise`

```ts
const tasks = new Listr([
 {
   title: 'æ‹‰å–é¡¹ç›®æ¨¡æ¿',
   task: () => download(answer),
  },
 {
   title: 'å¤„ç†æ¨¡æ¿æ’å€¼',
   task: () => interpolationAppConfigJson(answer),
  },
 {
   title: 'å®‰è£…é¡¹ç›®ä¾èµ–',
   task: () => setupNodeModules(answer),
  },
]);

await tasks.run();

```

è¿™æ ·ï¼ŒæŠŠä¸‰å¤§å—ä»»åŠ¡ç”¨`listr`è¿›è¡Œç®¡ç†ï¼Œè¿™æ ·ä»£ç çœ‹èµ·æ¥ä¹Ÿå°±ååˆ†æ¸…æ™°äº†ã€‚

#### xcli commit

`xcli commit`ï¼Œä¸ºä»€ä¹ˆè¦åšè¿™ä¸ªå‘¢ï¼Œå…¶å®å®Œå…¨æ˜¯ä¸ªäººçš„æƒ³æ³•ã€‚å…ˆæ¥ä»‹ç»è¿™ä¸ªåŠŸèƒ½ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬ç°åœ¨çš„å›½åœŸç©ºé—´é¡¹ç›®ï¼Œå†™`git message`éƒ½æ˜¯ç”¨`yarn commit`è¿™ç§æ–¹å¼ï¼Œå•¥æ˜¯`yarn commit`å‘¢ï¼Œå…¶å®å°±æ˜¯ä½¿ç”¨`git-cz`

![image-20200825160410275](https://img-1257816861.cos.ap-guangzhou.myqcloud.com/blog/image-20200825160410275.png)

è¿™é‡Œä¸ä¼šä»‹ç»git-czçš„ç”¨æ³•ï¼Œæœ‰å…´è¶£çš„å¯ä»¥googleå­¦ä¹ ä¸‹ã€‚è¿™ä¸ªä¸»è¦æ˜¯é…åˆ`commitlint`æ¥ä½¿ç”¨çš„ï¼Œèƒ½ç”Ÿæˆ**ç¬¦åˆè§„èŒƒ**çš„`git message`ï¼Œæ¯”å¦‚è¿™ç§`feat(å…¬å…±æ¨¡å—): æ–°å¢ä¸€ä¸ªåŠŸèƒ½`çš„`git message`ï¼Œæ˜¯ç¬¦åˆAngularå›¢é˜Ÿè§„èŒƒçš„ï¼Œçœ‹èµ·æ¥éå¸¸èˆ’æœï¼Œä¹Ÿæ–¹ä¾¿è®°å½•æŸ¥æ‰¾ã€‚ä½†æ˜¯ï¼Œæˆ‘å‘ç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œé…ç½®`git-cz`å’Œ`commitlint`è¿™äº›**éœ€è¦å®‰è£…å¥½å¤šçš„ä¾èµ–åº“**ï¼Œå¾ˆè€—æ—¶ï¼Œæ—¶é—´ä¹…äº†ä¹Ÿå®¹æ˜“å¿˜è®°ã€‚è™½ç„¶å¯ä»¥åœ¨æ¨¡æ¿ä¸Šé…ç½®ï¼Œç„¶ååœ¨æ–°é¡¹ç›®ä¸­ä½¿ç”¨ï¼Œä½†æ˜¯åœ¨**æ—§é¡¹ç›®ä¸­é…ç½®å°±éå¸¸ç¹ç**äº†ï¼Œæ‰€ä»¥æˆ‘æƒ³åˆ°äº†è¿™å®Œå…¨å¯ä»¥ä½¿ç”¨è„šæ‰‹æ¶æ¥æ¥ç®¡è¿™ä»¶äº‹ã€‚

ç»è¿‡ä¸€ç•ªç ”ç©¶ï¼Œå‘ç°`cz-customizable`è¿™ä¸ªåº“é‡Œé¢æä¾›äº†`standalone.js`æ¨¡å—æ”¯æŒç‹¬ç«‹è¿è¡Œï¼Œè¿™æ ·ï¼Œè¿™ä¸ªåŠŸèƒ½å®Œå…¨å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ¨¡å—æ¥å®ç°ä»¥ä¸Šéœ€æ±‚ã€‚

æŸ¥çœ‹äº†`standalone.js`æ¨¡å—çš„æºç ï¼Œå‘ç°æ˜¯éœ€è¦æä¾›`.cz-config.js`æ–‡ä»¶æ‰å¯ä»¥è¿è¡Œï¼Œæœ¬æ¥ä»¥ä¸ºè¿™ä¸ªåº“æœ‰å‡½æ•°æ”¯æŒä½¿ç”¨é…ç½®å¯¹è±¡æ¥æ‰§è¡Œï¼Œå°±ä¸å¼ºåˆ¶ç”¨æˆ·æä¾›äº†ï¼Œä½†æ˜¯çœ‹äº†æºç æ˜¯æ²¡æœ‰çš„ï¼Œå¯èƒ½ä½œè€…è§‰å¾—ç”¨æ–‡ä»¶æ¥ç®¡ç†æ¯”è¾ƒå¥½å§ã€‚äºæ˜¯ï¼Œæˆ‘è¿™è¾¹å°±åšäº†ä¸¤ç§é€‰æ‹©ï¼š

- å¦‚æœç”¨æˆ·é¡¹ç›®æ ¹ç›®å½•ä¸­æä¾›äº†`.cz-config.js`ï¼Œåˆ™ç›´æ¥è¿è¡Œ`standalone.js`
- å¦‚æœç”¨æˆ·é¡¹ç›®æ ¹ç›®å½•æ²¡æœ‰`.cz-config.js`æ–‡ä»¶ï¼Œåˆ™ä¼šæç¤ºæ˜¯å¦éœ€è¦è‡ªåŠ¨å¸®ç”¨æˆ·åˆ›å»º

```ts
export default async function commit(): Promise<void> {
  const isFileExists = await checkConfigFileExists();

  // æ ¡éªŒ.cz.config.jsæ–‡ä»¶æ˜¯å¦å­˜åœ¨
  if (isFileExists) {
    // è·‘standalone.js
    return runCz();
  }

  log.error(`é¡¹ç›®æ ¹ç›®å½•ä¸‹æ²¡æœ‰æ‰¾åˆ° ${hlText(CONFIGFILENAME)} é…ç½®æ–‡ä»¶!`);

  const { wantCreateFile } = await inquirer.prompt({
    type: 'confirm',
    name: 'wantCreateFile',
    message: `æ˜¯å¦éœ€è¦å¸®æ‚¨åˆ›å»º ${hlText(CONFIGFILENAME)} æ–‡ä»¶ï¼Ÿ`,
    default: true,
  });

  if (wantCreateFile) {
    await createConfigFile();

    log.success(`åˆ›å»º ${hlText(CONFIGFILENAME)} é…ç½®æ–‡ä»¶æˆåŠŸ!`);

    return runCz();
  } else {
    log(
      `ğŸƒ è¯·æ‰‹åŠ¨åˆ›å»º ${hlText(CONFIGFILENAME)} é…ç½®æ–‡ä»¶ï¼Œå†ä½¿ç”¨ ${hlText(
        'xcli commit'
      )}!`
    );
  }
}
```

#### xcli script

`xcli script`ä¸»è¦æ˜¯ç”¨è·‘å„ç§å·²æœ‰çš„åŠŸèƒ½è„šæœ¬ï¼Œå› ä¸ºä¹‹å‰åœ¨å„ä¸ªå›¢é˜Ÿéƒ½äº§å‡ºäº†ä¸€äº›è„šæœ¬ï¼Œæ‰€ä»¥è¿™è¾¹å°±è¦æŠŠè¿™äº›è„šæœ¬éƒ½é›†æˆè¿›æ¥ã€‚ç›®å‰è¿™äº›è„šæœ¬éƒ½æ˜¯ç”¨`js`å†™çš„ï¼Œä¸è¿‡æ²¡å…³ç³»ï¼Œ`ts`æ˜¯å¯ä»¥åŠ è½½`js`æ–‡ä»¶çš„ï¼Œåœ¨`tsconfig.json`ä¸­å¼€å¯`allowJs`å³å¯

```json
{
  "compilerOptions": {
    "allowJs": true
  }
}
```

å½“å‰å·²ç»é›†æˆäº†3ä¸ªè„šæœ¬ï¼Œä½¿ç”¨æ—¶å¯é€šè¿‡`inquirer`è¿›è¡Œè¯¢é—®

```ts
const questions: ListQuestionOptions = {
  type: 'list',
  name: 'scripts',
  message: 'é€‰æ‹©æ‰§è¡ŒåŠŸèƒ½è„šæœ¬',
  choices: [
    {
      name: 'ç”Ÿæˆä¸€ä¸ªvueç»„ä»¶',
      value: 'gen-comp',
    },
    {
      name: 'ç”Ÿæˆè¿ç»´æƒé™è·¯ç”±json',
      value: 'gen-route-json',
    },
    {
      name: 'ç”Ÿæˆrollup.config.jsé…ç½®æ–‡ä»¶',
      value: 'gen-rollup-config',
    },
  ],
};

export default async function scripts() {
  const answer = await inquirer.prompt([questions]);
  const { scripts } = answer;

  return scripts && scriptsMap[scripts]();
}
```

è¿™å—ä¸»è¦å°±æ˜¯æä¾›ä¸ªå¹³å°ç”¨æ¥å­˜æ”¾å’Œæ‰§è¡Œå„ç§`ts`æˆ–è€…`js`çš„nodeè„šæœ¬ï¼Œç›¸å…³è„šæœ¬è¿™è¾¹å°±ä¸ä½œå…·ä½“è®²è§£äº†ã€‚

#### xcli update

`xcli update`é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ç”¨æ¥æ›´æ–°`xcli`çš„ã€‚å½“ç”¨æˆ·å¯åŠ¨è„šæ‰‹æ¶çš„æ—¶å€™ï¼Œå°±ä¼šå»æ£€æµ‹æ˜¯å¦éœ€è¦æ›´æ–°ï¼Œç„¶åæŠŠæç¤ºä¿¡æ¯æ‰“å°å‡ºæ¥ï¼Œç°åœ¨å¾ˆå¤šè„šæ‰‹æ¶éƒ½æ˜¯æœ‰è¿™ä¸ªåŠŸèƒ½çš„ï¼Œæ‰€ä»¥æˆ‘è¿™è¾¹ä¹Ÿé¡ºä¾¿å®ç°äº†ä¸‹ã€‚

å…ˆæ¥æŠ›å‡ºä¸ªé—®é¢˜ï¼Œæ€ä¹ˆæ£€æµ‹æ›´æ–°ï¼Ÿ

åŸç†å¾ˆç®€å•ï¼Œå…¶å®`npm`æœ‰ä¸ªå‘½ä»¤æ˜¯æ”¯æŒçš„ï¼Œå³`npm show @dist/xcli version`å¯ä»¥æ‹¿åˆ°npmç§æœ‰ä»“åº“ä¸Šçš„æœ€æ–°ç‰ˆæœ¬ã€‚è¿™æ ·ï¼Œæ‹¿åˆ°äº†æœ€æ–°ç‰ˆæœ¬ï¼Œå’Œæœ¬åœ°`package.json`çš„`version`å€¼æ¯”è¾ƒä¸‹ï¼Œå°±çŸ¥é“æ˜¯å¦éœ€è¦æ›´æ–°äº†ã€‚

```ts
import pkg from '../../package.json';

export async function checkUpdate(
  needVersionInfo = false
): Promise<CheckUpdateInfo | boolean> {
  const isConfigCorrect = await checkNpmConfigCorrect(); // æ£€æŸ¥ npm é…ç½®æ˜¯å¦æ­£ç¡®

  if (!isConfigCorrect) return false;

  const { stdout } = await execa.command(`npm show @dist/xcli version`);
  const { version } = pkg;

  if (needVersionInfo) {
    return {
      shouldUpdate: stdout > version ? true : false,
      curVersion: version,
      newVersion: stdout,
    } as CheckUpdateInfo;
  }

  return stdout > version ? true : false;
}
```

å¦‚æœæ£€æµ‹åˆ°äº†éœ€è¦æ›´æ–°ï¼Œåˆ™ä¼šç»™ç”¨æˆ·æç¤º

![image-20200826134656879](https://img-1257816861.cos.ap-guangzhou.myqcloud.com/blog/image-20200826134656879.png)

å‡çº§çš„å…·ä½“å®ç°

```ts
export default async function update(): Promise<void> {
  // ä¿®æ”¹æ­£åœ¨å‡çº§çŠ¶æ€ï¼Œä¸ log æç¤ºå‡çº§æ¡†
  // è®¾ç½®é”
  setUpdating(true);

  const shouldUpdate = await checkUpdate();

  if (shouldUpdate) {
    const spinner = ora('æ­£åœ¨å‡çº§è„šæ‰‹æ¶ç‰ˆæœ¬...').start();
    try {
      await execa.command(`npm i -g @dist/xcli`);
      spinner.succeed('è„šæ‰‹æ¶ç‰ˆæœ¬å‡çº§æˆåŠŸï¼');
    } catch (error) {
      log(error);
      
      spinner.fail('è„šæ‰‹æ¶ç‰ˆæœ¬å‡çº§å¤±è´¥ï¼');

      log(`è¯·æ‰‹åŠ¨è¾“å…¥ ${hlText('npm i -g @dist/xcli')} å‡çº§`);

      setUpdating(false);
    }
  } else {
    setUpdating(false);

    ora().info('xcliå·²ç»æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼');
  }
}
```

#### xcli initenv

`xcli initenv`ä¸»è¦æ˜¯ç”¨äºåˆå§‹åŒ–å¼€å‘ç¯å¢ƒï¼Œç›®å‰ä¸»è¦ç”¨äºå¿«é€Ÿç”Ÿæˆvscodeçš„`settings.json`æ–‡ä»¶ï¼ŒåŸºç¡€æ¨¡æ¿æ˜¯å·²ç»é…å¥½`settings.json`çš„ï¼Œä½†æ˜¯å¾ˆå¤šæ—§é¡¹ç›®æ˜¯æ²¡æœ‰é…å¥½çš„ï¼Œæ‰€ä»¥è¿™ä¸ªå‘½ä»¤å¯ä»¥åœ¨æ—§é¡¹ç›®ä¸­ä¸€é”®ç”Ÿæˆé…ç½®ä¿¡æ¯ã€‚

ä»£ç å®ç°ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåªæ˜¯æŠŠå†…ç½®çš„`settings.json`æ‹·è´è¿‡å»å³å¯

```ts
import settinsJson from './settings.json';

const SETTINGSJSONTARGET = path.resolve(
  process.cwd(),
  './.vscode/settings.json'
);

async function initVscodeSettings() {
  const spinner = ora('æ­£åœ¨åˆå§‹åŒ–é¡¹ç›®vscodeé…ç½®ä¿¡æ¯').start();

  try {
    await fs.outputFile(
      SETTINGSJSONTARGET,
      JSON.stringify(settinsJson, null, 2),
      'utf8'
    );

    spinner.succeed('åˆå§‹åŒ–é¡¹ç›®vscodeé…ç½®ä¿¡æ¯æˆåŠŸ');
  } catch (error) {
    console.log(error);
    spinner.fail('åˆå§‹åŒ–é¡¹ç›®vscodeé…ç½®ä¿¡æ¯å¤±è´¥');
  }
}

export default async function initEnv(): Promise<void> {
  await initVscodeSettings();
  // æœªæ¥å°†ä¼šæ”¯æŒæ›´å¤šåŠŸèƒ½...
}
```

## æ€»ç»“

å¯ä»¥å‘ç°ï¼Œå…¶å®å¼€å‘ä¸€ä¸ªè„šæ‰‹æ¶ä¸€ç‚¹éƒ½ä¸éš¾ï¼Œåªéœ€è¦ç†Ÿæ‚‰ä¸€äº›`nodejs`å’Œä¸€äº›`shell`å‘½ä»¤å°±èƒ½æå‡ºæ¥ã€‚æ¯ä¸ªäººå¯ä»¥æ ¹æ®ä¸ªäººä¹ æƒ¯ï¼Œå†™ä¸ªè‡ªç”¨ç‰ˆçš„è„šæ‰‹æ¶å‡ºæ¥ï¼Œå…·ä½“è¦åšä»€ä¹ˆï¼Œå®Œå…¨çœ‹ä½ æ€ä¹ˆå‘æŒ¥å•¦ï¼Œä¸€åˆ‡éƒ½æ˜¯ä¸ºäº†ææ•ˆ(å·æ‡’)ã€‚

